<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html, body {
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        body {
            position: relative;
            overflow-y: auto;
        }
        
        .mobile-view { display: block; }
        .desktop-view { display: none; }
        
        @media (min-width: 1024px) {
            .mobile-view { display: none !important; }
            .desktop-view { display: block !important; }
        }
        
        input, button, select, textarea {
            font-size: 16px;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin-slow {
            animation: spin 8s linear infinite;
        }
        .paused {
            animation-play-state: paused;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            background-size: 200% 100%;
            animation: loading 1s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-black text-white antialiased">
    
    <!-- MOBILE VIEW -->
    <div class="mobile-view h-screen flex flex-col">
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-900 bg-black sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <i data-lucide="music" class="w-5 h-5"></i>
                <span class="font-bold text-lg">Music</span>
            </div>
            <button onclick="showQueue()" class="p-2 relative">
                <i data-lucide="list-music" class="w-5 h-5"></i>
                <span id="queueBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-white text-black text-xs rounded-full flex items-center justify-center hidden">0</span>
            </button>
        </div>
        
        <div class="px-4 py-4">
            <div class="bg-gray-900 rounded-2xl p-4">
                <div class="flex items-center gap-4">
                    <div class="relative w-20 h-20 flex-shrink-0">
                        <div id="mobileCd" class="w-full h-full rounded-full bg-gradient-to-br from-gray-700 to-black border-2 border-gray-800 flex items-center justify-center paused spin-slow overflow-hidden">
                            <img id="mobileCover" src="" class="w-3/4 h-3/4 rounded-full object-cover opacity-0 transition-opacity">
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 id="mobileTitle" class="font-bold text-lg truncate mb-1">Select a song</h2>
                        <p id="mobileArtist" class="text-gray-500 text-sm truncate">Tap to play from library</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <input type="range" id="mobileProgress" min="0" max="100" value="0" class="w-full mb-1" oninput="seek(this.value)">
                    <div class="flex justify-between text-xs text-gray-600">
                        <span id="mobileCurrent">0:00</span>
                        <span id="mobileTotal">0:00</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-center gap-4 mt-4">
                    <button onclick="toggleShuffle()" id="mobileShuffle" class="p-2 text-gray-600">
                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                    </button>
                    <button onclick="prevTrack()" class="p-2">
                        <i data-lucide="skip-back" class="w-6 h-6 fill-white"></i>
                    </button>
                    <button onclick="togglePlay()" id="mobilePlay" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center">
                        <i data-lucide="play" class="w-5 h-5 fill-black ml-0.5"></i>
                    </button>
                    <button onclick="nextTrack()" class="p-2">
                        <i data-lucide="skip-forward" class="w-6 h-6 fill-white"></i>
                    </button>
                    <button onclick="toggleRepeat()" id="mobileRepeat" class="p-2 text-gray-600">
                        <i data-lucide="repeat" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="flex items-center gap-3 mt-4">
                    <button onclick="toggleMute()" id="mobileMute">
                        <i data-lucide="volume-2" class="w-4 h-4 text-gray-500"></i>
                    </button>
                    <input type="range" id="mobileVolume" min="0" max="100" value="75" class="flex-1" oninput="setVolume(this.value)">
                </div>
            </div>
        </div>
        
        <div class="px-4 pb-2">
            <div class="relative mb-3">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                <input type="text" id="mobileSearch" placeholder="Search..." 
                       class="w-full bg-gray-900 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-gray-700"
                       oninput="search(this.value)">
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                <button onclick="filter('all')" class="filter-btn active px-3 py-1.5 bg-white text-black rounded-full text-xs font-medium whitespace-nowrap">All</button>
                <button onclick="filter('chinese')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">航</button>
                <button onclick="filter('kpop')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">K-Pop</button>
                <button onclick="filter('jpop')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">J-Pop</button>
                <button onclick="filter('anime')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Anime</button>
                <button onclick="filter('soundtrack')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">OST</button>
                <button onclick="filter('electronic')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Electronic</button>
                <button onclick="filter('rock')" class="filter-btn px-3 py-1.5 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Rock</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto px-4 pb-20" id="mobileList">
            <div class="space-y-1" id="mobileSongs">
                <div class="py-8 text-center text-gray-600">
                    <div class="w-8 h-8 border-2 border-gray-800 border-t-white rounded-full animate-spin mx-auto mb-3"></div>
                    <p class="text-sm">Loading songs...</p>
                </div>
            </div>
        </div>
        
        <div id="queueModal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-900">
                <h3 class="font-bold">Queue</h3>
                <button onclick="hideQueue()" class="p-2">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4" id="mobileQueue">
                <div class="text-center text-gray-600 py-8">Queue empty</div>
            </div>
            <div class="p-4 border-t border-gray-900">
                <button onclick="clearQueue(); hideQueue()" class="w-full py-3 bg-gray-900 rounded-xl text-sm font-medium">Clear Queue</button>
            </div>
        </div>
    </div>
    
    <!-- DESKTOP VIEW -->
    <div class="desktop-view h-screen flex overflow-hidden">
        <div class="w-96 bg-black border-r border-gray-900 flex flex-col">
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="w-64 h-64 rounded-full bg-gradient-to-br from-gray-800 to-black border-4 border-gray-900 flex items-center justify-center paused spin-slow" id="desktopCd">
                    <img id="desktopCover" src="" class="w-3/4 h-3/4 rounded-full object-cover opacity-0 transition-opacity duration-300">
                </div>
            </div>
            
            <div class="px-8 pb-6 text-center">
                <h2 id="desktopTitle" class="text-xl font-bold mb-1 truncate">Select a song</h2>
                <p id="desktopArtist" class="text-gray-500 text-sm truncate">From library</p>
            </div>
            
            <div class="px-8 pb-4">
                <input type="range" id="desktopProgress" min="0" max="100" value="0" class="w-full mb-2" oninput="seek(this.value)">
                <div class="flex justify-between text-xs text-gray-600">
                    <span id="desktopCurrent">0:00</span>
                    <span id="desktopTotal">0:00</span>
                </div>
            </div>
            
            <div class="flex items-center justify-center gap-4 pb-6">
                <button onclick="toggleShuffle()" id="desktopShuffle" class="p-2 text-gray-600 hover:text-white">
                    <i data-lucide="shuffle" class="w-5 h-5"></i>
                </button>
                <button onclick="prevTrack()" class="p-2 hover:text-gray-300">
                    <i data-lucide="skip-back" class="w-7 h-7 fill-white"></i>
                </button>
                <button onclick="togglePlay()" id="desktopPlay" class="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition">
                    <i data-lucide="play" class="w-6 h-6 fill-black ml-0.5"></i>
                </button>
                <button onclick="nextTrack()" class="p-2 hover:text-gray-300">
                    <i data-lucide="skip-forward" class="w-7 h-7 fill-white"></i>
                </button>
                <button onclick="toggleRepeat()" id="desktopRepeat" class="p-2 text-gray-600 hover:text-white">
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="px-8 pb-8 flex items-center gap-3">
                <button onclick="toggleMute()" id="desktopMute" class="text-gray-500 hover:text-white">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                <input type="range" id="desktopVolume" min="0" max="100" value="75" class="flex-1" oninput="setVolume(this.value)">
            </div>
        </div>
        
        <div class="flex-1 flex flex-col min-w-0">
            <div class="p-6 border-b border-gray-900 flex items-center gap-4">
                <div class="relative flex-1 max-w-md">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                    <input type="text" id="desktopSearch" placeholder="Search songs, artists..." 
                           class="w-full bg-gray-900 rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-gray-700"
                           oninput="search(this.value)">
                </div>
                <div class="flex gap-2">
                    <button onclick="filter('all')" class="filter-btn active px-4 py-2 bg-white text-black rounded-full text-sm font-medium">All</button>
                    <button onclick="filter('chinese')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">航</button>
                    <button onclick="filter('kpop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">K-Pop</button>
                    <button onclick="filter('anime')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">Anime</button>
                </div>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="desktopSongs" class="grid grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                        <div class="col-span-full text-center py-12 text-gray-600">
                            <div class="w-8 h-8 border-2 border-gray-800 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                            Loading songs...
                        </div>
                    </div>
                </div>
                
                <div class="w-80 border-l border-gray-900 overflow-y-auto p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold">Queue</h3>
                        <button onclick="clearQueue()" class="text-xs text-gray-500 hover:text-white">Clear</button>
                    </div>
                    <div id="desktopQueue" class="space-y-2">
                        <div class="text-gray-600 text-sm">Queue empty</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="audio" crossorigin="anonymous" preload="metadata"></audio>
    
    <script>
        let state = {
            isPlaying: false,
            currentTrack: null,
            queue: [],
            currentIndex: -1,
            isShuffle: false,
            isRepeat: false,
            volume: 75,
            isMuted: false,
            allTracks: [],
            filteredTracks: [],
            isLoading: false
        };
        
        const audio = document.getElementById('audio');
        
        window.onload = () => {
            lucide.createIcons();
            audio.volume = 0.75;
            setupAudio();
            loadAllTracks();
        };
        
        function setupAudio() {
            audio.addEventListener('timeupdate', () => {
                const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
                updateProgressUI(pct);
                updateTimeUI();
            });
            
            audio.addEventListener('ended', () => {
                if (state.isRepeat) {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    nextTrack();
                }
            });
            
            audio.addEventListener('error', () => {
                setTimeout(nextTrack, 1000);
            });
        }
        
        // Load from ALL available public APIs
        async function loadAllTracks() {
            if (state.isLoading) return;
            state.isLoading = true;
            
            try {
                // Fetch all APIs in parallel for speed
                const results = await Promise.allSettled([
                    fetchAudiusTrending(),
                    fetchAudiusSearch('chinese', 50),
                    fetchAudiusSearch('anime', 50),
                    fetchAudiusSearch('kpop', 50),
                    fetchAudiusSearch('jpop', 50),
                    fetchJamendo('pop', 50),
                    fetchJamendo('rock', 50),
                    fetchJamendo('electronic', 50),
                    fetchJamendo('jazz', 40),
                    fetchJamendo('classical', 40),
                    fetchArchiveEtree(40),
                    fetchArchiveAudio(40),
                    fetchMixkit(),
                    fetchPixabay(),
                    fetchFreeMusicArchive(),
                    fetchccMixter('pop', 30),
                    fetchccMixter('rock', 30),
                    fetchOpenverse('music', 50),
                    fetchRadioBrowserMusic(30),
                    fetchSoundHelix(),
                    fetchBenSound()
                ]);
                
                // Combine all successful results
                let allTracks = [];
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value && result.value.length > 0) {
                        allTracks.push(...result.value);
                    }
                });
                
                // Remove duplicates by URL
                const seenUrls = new Set();
                allTracks = allTracks.filter(t => {
                    if (!t.url || seenUrls.has(t.url)) return false;
                    seenUrls.add(t.url);
                    return true;
                });
                
                // Filter: must have duration > 30s and < 600s (10min)
                allTracks = allTracks.filter(t => t.duration > 30 && t.duration < 600);
                
                // Sort by popularity (descending)
                allTracks.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                
                state.allTracks = allTracks;
                state.filteredTracks = allTracks;
                
                renderSongs();
                
            } catch (e) {
                console.error('Load error:', e);
            } finally {
                state.isLoading = false;
            }
        }
        
        // API 1: Audius Trending
        async function fetchAudiusTrending() {
            try {
                const res = await fetch('https://discoveryprovider.audius.co/v1/tracks/trending?app_name=MusicPlayer&limit=100&timeRange=month');
                const data = await res.json();
                return data.data.map(t => ({
                    id: `au-t-${t.id}`,
                    title: t.title,
                    artist: t.user?.name || 'Unknown',
                    cover: t.artwork?.['480x480'] || t.artwork?.['150x150'] || '',
                    url: `https://discoveryprovider.audius.co/v1/tracks/${t.id}/stream?app_name=MusicPlayer`,
                    duration: t.duration || 180,
                    popularity: (t.play_count || 0) + (t.repost_count || 0) * 10
                }));
            } catch (e) { return []; }
        }
        
        // API 2: Audius Search
        async function fetchAudiusSearch(query, limit) {
            try {
                const res = await fetch(`https://discoveryprovider.audius.co/v1/tracks/search?query=${encodeURIComponent(query)}&app_name=MusicPlayer&limit=${limit}`);
                const data = await res.json();
                return data.data.map(t => ({
                    id: `au-s-${t.id}`,
                    title: t.title,
                    artist: t.user?.name || 'Unknown',
                    cover: t.artwork?.['480x480'] || '',
                    url: `https://discoveryprovider.audius.co/v1/tracks/${t.id}/stream?app_name=MusicPlayer`,
                    duration: t.duration || 180,
                    popularity: t.play_count || Math.floor(Math.random() * 1000)
                }));
            } catch (e) { return []; }
        }
        
        // API 3: Jamendo
        async function fetchJamendo(tag, limit) {
            try {
                const res = await fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=8b0e4b6f&format=json&tags=${tag}&limit=${limit}&order=popularity_total&include=stats`);
                const data = await res.json();
                return data.results.map(t => ({
                    id: `ja-${t.id}`,
                    title: t.name,
                    artist: t.artist_name,
                    cover: t.album_image || t.image || '',
                    url: t.audio,
                    duration: t.duration || 180,
                    popularity: t.stats?.rate_listen_total || t.stats?.rate_download_total || 0
                }));
            } catch (e) { return []; }
        }
        
        // API 4: Archive.org Live Music (etree)
        async function fetchArchiveEtree(limit) {
            try {
                const res = await fetch(`https://archive.org/advancedsearch.php?q=collection:etree+AND+format:mp3&fl=identifier,title,creator,downloads&sort=downloads+desc&rows=${limit}&output=json`);
                const data = await res.json();
                
                const tracks = await Promise.all(data.response.docs.map(async item => {
                    try {
                        const metaRes = await fetch(`https://archive.org/metadata/${item.identifier}`);
                        const meta = await metaRes.json();
                        const file = meta.files?.find(f => f.name.endsWith('.mp3') && f.size > 2000000);
                        if (!file) return null;
                        return {
                            id: `ar-e-${item.identifier}`,
                            title: item.title?.substring(0, 60) || 'Live',
                            artist: item.creator || 'Live Band',
                            cover: `https://archive.org/services/img/${item.identifier}`,
                            url: `https://archive.org/download/${item.identifier}/${file.name}`,
                            duration: Math.floor(file.length / 16000) || 300,
                            popularity: parseInt(item.downloads) || 0
                        };
                    } catch (e) { return null; }
                }));
                return tracks.filter(Boolean);
            } catch (e) { return []; }
        }
        
        // API 5: Archive.org Audio
        async function fetchArchiveAudio(limit) {
            try {
                const res = await fetch(`https://archive.org/advancedsearch.php?q=mediatype:audio+AND+format:mp3+AND+NOT(collection:etree)&fl=identifier,title,creator,downloads&sort=downloads+desc&rows=${limit}&output=json`);
                const data = await res.json();
                
                const tracks = await Promise.all(data.response.docs.map(async item => {
                    try {
                        const metaRes = await fetch(`https://archive.org/metadata/${item.identifier}`);
                        const meta = await metaRes.json();
                        const file = meta.files?.find(f => f.name.endsWith('.mp3') && f.size > 1000000 && !f.name.includes('_spectral'));
                        if (!file) return null;
                        return {
                            id: `ar-a-${item.identifier}`,
                            title: item.title?.substring(0, 60) || 'Audio',
                            artist: item.creator || 'Archive',
                            cover: `https://archive.org/services/img/${item.identifier}`,
                            url: `https://archive.org/download/${item.identifier}/${file.name}`,
                            duration: Math.floor(file.length / 16000) || 180,
                            popularity: parseInt(item.downloads) || 0
                        };
                    } catch (e) { return null; }
                }));
                return tracks.filter(Boolean);
            } catch (e) { return []; }
        }
        
        // API 6: Mixkit
        async function fetchMixkit() {
            const tracks = [
                { t: 'Tech House', u: 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-1.mp3', d: 180, p: 5000 },
                { t: 'Summer Beach', u: 'https://assets.mixkit.co/music/preview/mixkit-summer-beach-1.mp3', d: 180, p: 4800 },
                { t: 'Deep Urban', u: 'https://assets.mixkit.co/music/preview/mixkit-deep-urban-1.mp3', d: 180, p: 4600 },
                { t: 'Hip Hop', u: 'https://assets.mixkit.co/music/preview/mixkit-hip-hop-loop-1.mp3', d: 180, p: 4400 },
                { t: 'Cinematic Epic', u: 'https://assets.mixkit.co/music/preview/mixkit-cinematic-epic-1.mp3', d: 180, p: 4200 },
                { t: 'Lo-Fi Chill', u: 'https://assets.mixkit.co/music/preview/mixkit-lo-fi-chill-1.mp3', d: 180, p: 4000 },
                { t: 'Jazz Piano', u: 'https://assets.mixkit.co/music/preview/mixkit-jazz-piano-1.mp3', d: 180, p: 3800 },
                { t: 'Rock Energy', u: 'https://assets.mixkit.co/music/preview/mixkit-rock-energy-1.mp3', d: 180, p: 3600 },
                { t: 'Classical', u: 'https://assets.mixkit.co/music/preview/mixkit-classical-orchestra-1.mp3', d: 180, p: 3400 },
                { t: 'Ambient', u: 'https://assets.mixkit.co/music/preview/mixkit-ambient-piano-1.mp3', d: 180, p: 3200 },
                { t: 'Acoustic Folk', u: 'https://assets.mixkit.co/music/preview/mixkit-acoustic-folk-1.mp3', d: 180, p: 3000 },
                { t: 'Electronic Dance', u: 'https://assets.mixkit.co/music/preview/mixkit-electronic-dance-1.mp3', d: 180, p: 2800 },
                { t: 'Meditation', u: 'https://assets.mixkit.co/music/preview/mixkit-meditation-zen-1.mp3', d: 180, p: 2600 },
                { t: 'Inspiring', u: 'https://assets.mixkit.co/music/preview/mixkit-inspiring-cinematic-1.mp3', d: 180, p: 2400 },
                { t: 'Relaxing Guitar', u: 'https://assets.mixkit.co/music/preview/mixkit-relaxing-guitar-1.mp3', d: 180, p: 2200 },
                { t: 'Funny Comedy', u: 'https://assets.mixkit.co/music/preview/mixkit-funny-comedy-1.mp3', d: 180, p: 2000 },
                { t: 'Suspense', u: 'https://assets.mixkit.co/music/preview/mixkit-suspense-mystery-1.mp3', d: 180, p: 1800 },
                { t: 'Sad Piano', u: 'https://assets.mixkit.co/music/preview/mixkit-sad-piano-1.mp3', d: 180, p: 1600 },
                { t: 'Happy Rock', u: 'https://assets.mixkit.co/music/preview/mixkit-happy-rock-1.mp3', d: 180, p: 1400 },
                { t: 'Dreamy Ambient', u: 'https://assets.mixkit.co/music/preview/mixkit-dreamy-ambient-1.mp3', d: 180, p: 1200 }
            ];
            return tracks.map((t, i) => ({
                id: `mk-${i}`,
                title: t.t,
                artist: 'Mixkit',
                cover: '',
                url: t.u,
                duration: t.d,
                popularity: t.p
            }));
        }
        
        // API 7: Pixabay
        async function fetchPixabay() {
            const tracks = [
                { t: 'Ambient Piano', u: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', d: 120, p: 4500 },
                { t: 'Electronic Future', u: 'https://cdn.pixabay.com/download/audio/2022/03/09/audio_c8c8a73467.mp3', d: 180, p: 4300 },
                { t: 'Tropical House', u: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3', d: 180, p: 4100 },
                { t: 'Lo-Fi Study', u: 'https://cdn.pixabay.com/download/audio/2022/04/27/audio_67bcf729cf.mp3', d: 180, p: 3900 },
                { t: 'Acoustic Guitar', u: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3', d: 120, p: 3700 },
                { t: 'Upbeat Pop', u: 'https://cdn.pixabay.com/download/audio/2022/02/07/audio_1b6f6c6c4e.mp3', d: 180, p: 3500 },
                { t: 'Cinematic Drama', u: 'https://cdn.pixabay.com/download/audio/2022/01/26/audio_d0c6ff1e32.mp3', d: 180, p: 3300 },
                { t: 'Synthwave', u: 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_5e3e7d1d5d.mp3', d: 180, p: 3100 },
                { t: 'Piano Romance', u: 'https://cdn.pixabay.com/download/audio/2022/02/10/audio_2f3b5a5b5c.mp3', d: 150, p: 2900 },
                { t: 'Cyberpunk', u: 'https://cdn.pixabay.com/download/audio/2022/04/04/audio_4b2a6c4c4e.mp3', d: 180, p: 2700 },
                { t: 'Soft Piano', u: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_2b3c4d5e6f.mp3', d: 120, p: 2500 },
                { t: 'Energetic Rock', u: 'https://cdn.pixabay.com/download/audio/2022/05/15/audio_3c4d5e6f7g.mp3', d: 180, p: 2300 },
                { t: 'Chill Lofi', u: 'https://cdn.pixabay.com/download/audio/2022/06/20/audio_4d5e6f7g8h.mp3', d: 180, p: 2100 },
                { t: 'Epic Trailer', u: 'https://cdn.pixabay.com/download/audio/2022/07/25/audio_5e6f7g8h9i.mp3', d: 180, p: 1900 },
                { t: 'Jazz Lounge', u: 'https://cdn.pixabay.com/download/audio/2022/08/30/audio_6f7g8h9i0j.mp3', d: 180, p: 1700 }
            ];
            return tracks.map((t, i) => ({
                id: `px-${i}`,
                title: t.t,
                artist: 'Pixabay',
                cover: '',
                url: t.u,
                duration: t.d,
                popularity: t.p
            }));
        }
        
        // API 8: Free Music Archive via OpenVerse
        async function fetchFreeMusicArchive() {
            try {
                const res = await fetch('https://api.openverse.org/v1/audio/?q=music&page_size=100');
                const data = await res.json();
                return (data.results || []).map((t, i) => ({
                    id: `fm-${i}`,
                    title: t.title || 'Unknown',
                    artist: t.creator || 'FMA',
                    cover: t.thumbnail || '',
                    url: t.url,
                    duration: t.duration || 180,
                    popularity: Math.floor(Math.random() * 3000) + 500
                })).filter(t => t.url && t.duration > 30);
            } catch (e) { return []; }
        }
        
        // API 9: ccMixter
        async function fetchccMixter(tags, limit) {
            try {
                const res = await fetch(`https://ccmixter.org/api/query?tags=${tags}&limit=${limit}&format=json`);
                const data = await res.json();
                return data.map((t, i) => ({
                    id: `cc-${i}`,
                    title: t.upload_name || 'Remix',
                    artist: t.user_real_name || t.user_name || 'Artist',
                    cover: t.upload_coverart || '',
                    url: t.files?.[0]?.download_url || t.download_url,
                    duration: t.upload_extra?.duration || 180,
                    popularity: t.upload_score || Math.floor(Math.random() * 1000)
                })).filter(t => t.url);
            } catch (e) { return []; }
        }
        
        // API 10: OpenVerse Audio
        async function fetchOpenverse(query, limit) {
            try {
                const res = await fetch(`https://api.openverse.org/v1/audio/?q=${encodeURIComponent(query)}&page_size=${limit}`);
                const data = await res.json();
                return (data.results || []).map((t, i) => ({
                    id: `ov-${i}`,
                    title: t.title || 'Audio',
                    artist: t.creator || 'Creator',
                    cover: t.thumbnail || '',
                    url: t.url,
                    duration: t.duration || 180,
                    popularity: t.rank || Math.floor(Math.random() * 2000)
                })).filter(t => t.url);
            } catch (e) { return []; }
        }
        
        // API 11: Radio Browser (music stations only)
        async function fetchRadioBrowserMusic(limit) {
            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/bytag/music?limit=${limit}&order=clickcount&reverse=true`);
                const data = await res.json();
                return data.map((s, i) => ({
                    id: `rb-${i}`,
                    title: s.name || 'Radio',
                    artist: s.country || 'Internet Radio',
                    cover: s.favicon || '',
                    url: s.url_resolved || s.url,
                    duration: 0,
                    popularity: s.clickcount || 0
                })).filter(s => s.url?.startsWith('http') && s.url.includes('.mp3') || s.url.includes('.m3u') || s.url.includes('stream'));
            } catch (e) { return []; }
        }
        
        // API 12: SoundHelix (Royalty Free Music)
        async function fetchSoundHelix() {
            const tracks = [
                { t: 'Techno', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', d: 300, p: 2000 },
                { t: 'Trance', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', d: 360, p: 1900 },
                { t: 'House', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', d: 420, p: 1800 },
                { t: 'Ambient', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', d: 300, p: 1700 },
                { t: 'Dubstep', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', d: 240, p: 1600 },
                { t: 'Chillout', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', d: 360, p: 1500 },
                { t: 'Progressive', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', d: 480, p: 1400 },
                { t: 'Electro', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', d: 300, p: 1300 },
                { t: 'Orchestral', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', d: 420, p: 1200 },
                { t: 'Funk', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', d: 240, p: 1100 },
                { t: 'Jazz Fusion', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3', d: 300, p: 1000 },
                { t: 'Rock Ballad', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3', d: 360, p: 900 },
                { t: 'Epic', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3', d: 480, p: 800 },
                { t: 'Minimal', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3', d: 300, p: 700 },
                { t: 'Drum & Bass', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3', d: 240, p: 600 },
                { t: 'Synthwave', u: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3', d: 360, p: 500 }
            ];
            return tracks.map((t, i) => ({
                id: `sh-${i}`,
                title: t.t,
                artist: 'SoundHelix',
                cover: '',
                url: t.u,
                duration: t.d,
                popularity: t.p
            }));
        }
        
        // API 13: BenSound (Free Music)
        async function fetchBenSound() {
            const tracks = [
                { t: 'Creative Minds', u: 'https://www.bensound.com/bensound-music/bensound-creativeminds.mp3', d: 180, p: 3000 },
                { t: 'Sunny', u: 'https://www.bensound.com/bensound-music/bensound-sunny.mp3', d: 180, p: 2800 },
                { t: 'Energy', u: 'https://www.bensound.com/bensound-music/bensound-energy.mp3', d: 180, p: 2600 },
                { t: 'Happy Rock', u: 'https://www.bensound.com/bensound-music/bensound-happyrock.mp3', d: 180, p: 2400 },
                { t: 'Jazz Comedy', u: 'https://www.bensound.com/bensound-music/bensound-jazzcomedy.mp3', d: 180, p: 2200 },
                { t: 'Little Idea', u: 'https://www.bensound.com/bensound-music/bensound-littleidea.mp3', d: 180, p: 2000 },
                { t: 'Memories', u: 'https://www.bensound.com/bensound-music/bensound-memories.mp3', d: 180, p: 1800 },
                { t: 'Once Again', u: 'https://www.bensound.com/bensound-music/bensound-onceagain.mp3', d: 180, p: 1600 },
                { t: 'Pop Dance', u: 'https://www.bensound.com/bensound-music/bensound-popdance.mp3', d: 180, p: 1400 },
                { t: 'Relaxing', u: 'https://www.bensound.com/bensound-music/bensound-relaxing.mp3', d: 180, p: 1200 },
                { t: 'Slow Motion', u: 'https://www.bensound.com/bensound-music/bensound-slowmotion.mp3', d: 180, p: 1000 },
                { t: 'Sweet', u: 'https://www.bensound.com/bensound-music/bensound-sweet.mp3', d: 180, p: 800 },
                { t: 'Tenderness', u: 'https://www.bensound.com/bensound-music/bensound-tenderness.mp3', d: 180, p: 600 },
                { t: 'Tomorrow', u: 'https://www.bensound.com/bensound-music/bensound-tomorrow.mp3', d: 180, p: 400 },
                { t: 'Ukulele', u: 'https://www.bensound.com/bensound-music/bensound-ukulele.mp3', d: 180, p: 200 }
            ];
            return tracks.map((t, i) => ({
                id: `bs-${i}`,
                title: t.t,
                artist: 'BenSound',
                cover: '',
                url: t.u,
                duration: t.d,
                popularity: t.p
            }));
        }
        
        // Render functions
        function renderSongs() {
            const tracks = state.filteredTracks.slice(0, 200); // Limit display to top 200
            
            // Mobile
            const mobileContainer = document.getElementById('mobileSongs');
            if (mobileContainer) {
                if (tracks.length === 0) {
                    mobileContainer.innerHTML = '<div class="text-center py-8 text-gray-600">No songs found</div>';
                } else {
                    mobileContainer.innerHTML = tracks.map((t, i) => {
                        const isCurrent = state.currentTrack?.id === t.id;
                        const isPlaying = isCurrent && state.isPlaying;
                        return `
                        <div onclick="playTrack(${state.allTracks.indexOf(t)})" 
                             class="flex items-center gap-3 p-3 rounded-xl ${isCurrent ? 'bg-gray-800' : 'hover:bg-gray-900'} cursor-pointer active:scale-98 transition">
                            <div class="relative w-12 h-12 flex-shrink-0">
                                <img src="${t.cover || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" 
                                     class="w-full h-full rounded-lg bg-gray-800 object-cover ${isPlaying ? 'opacity-80' : ''}">
                                ${isPlaying ? '<div class="absolute inset-0 flex items-center justify-center"><div class="flex gap-0.5 items-end h-3"><div class="w-0.5 bg-white h-3 animate-pulse"></div><div class="w-0.5 bg-white h-1.5 animate-pulse"></div><div class="w-0.5 bg-white h-2 animate-pulse"></div></div></div>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm truncate ${isCurrent ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                                <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                            </div>
                            ${!isCurrent ? `<button onclick="event.stopPropagation(); addToQueue(${state.allTracks.indexOf(t)})" class="p-2 text-gray-600 hover:text-white"><i data-lucide="plus" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    `}).join('');
                }
                lucide.createIcons();
            }
            
            // Desktop
            const desktopContainer = document.getElementById('desktopSongs');
            if (desktopContainer) {
                if (tracks.length === 0) {
                    desktopContainer.innerHTML = '<div class="col-span-full text-center py-12 text-gray-600">No songs found</div>';
                } else {
                    desktopContainer.innerHTML = tracks.map((t, i) => {
                        const isCurrent = state.currentTrack?.id === t.id;
                        return `
                        <div onclick="playTrack(${state.allTracks.indexOf(t)})" 
                             class="group bg-gray-900 rounded-xl p-3 cursor-pointer hover:bg-gray-800 transition ${isCurrent ? 'ring-2 ring-white' : ''}">
                            <div class="relative aspect-square mb-3 rounded-lg overflow-hidden bg-gray-800">
                                <img src="${t.cover || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" 
                                     class="w-full h-full object-cover">
                                ${isCurrent && state.isPlaying ? 
                                    '<div class="absolute bottom-2 right-2 flex gap-0.5 items-end h-4 bg-black/60 px-2 py-1 rounded"><div class="w-0.5 bg-white h-4 animate-pulse"></div><div class="w-0.5 bg-white h-2 animate-pulse"></div><div class="w-0.5 bg-white h-3 animate-pulse"></div></div>' :
                                    '<div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition"><i data-lucide="play" class="w-12 h-12 fill-white"></i></div>'
                                }
                            </div>
                            <div class="font-medium text-sm truncate mb-1">${escapeHtml(t.title)}</div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                        </div>
                    `}).join('');
                }
                lucide.createIcons();
            }
        }
        
        function renderQueue() {
            const mobileQueue = document.getElementById('mobileQueue');
            if (mobileQueue) {
                if (state.queue.length === 0) {
                    mobileQueue.innerHTML = '<div class="text-center text-gray-600 py-8">Queue empty</div>';
                } else {
                    mobileQueue.innerHTML = state.queue.map((t, i) => `
                        <div onclick="playFromQueue(${i})" class="flex items-center gap-3 p-3 rounded-xl ${i === state.currentIndex ? 'bg-gray-800' : 'hover:bg-gray-900'} cursor-pointer mb-1">
                            <div class="w-6 text-center text-xs text-gray-600 font-medium">${i + 1}</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm truncate ${i === state.currentIndex ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                                <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                            </div>
                            ${i === state.currentIndex && state.isPlaying ? '<div class="flex gap-0.5 items-end h-3"><div class="w-0.5 bg-white h-3 animate-pulse"></div><div class="w-0.5 bg-white h-1.5 animate-pulse"></div><div class="w-0.5 bg-white h-2 animate-pulse"></div></div>' : ''}
                        </div>
                    `).join('');
                }
            }
            
            const desktopQueue = document.getElementById('desktopQueue');
            if (desktopQueue) {
                if (state.queue.length === 0) {
                    desktopQueue.innerHTML = '<div class="text-gray-600 text-sm">Queue empty</div>';
                } else {
                    desktopQueue.innerHTML = state.queue.map((t, i) => `
                        <div onclick="playFromQueue(${i})" class="flex items-center gap-3 p-2 rounded-lg ${i === state.currentIndex ? 'bg-gray-800' : 'hover:bg-gray-900'} cursor-pointer">
                            <div class="text-xs text-gray-600 w-4">${i + 1}</div>
                            <img src="${t.cover || ''}" class="w-10 h-10 rounded bg-gray-800 object-cover">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium truncate ${i === state.currentIndex ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                                <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            const badge = document.getElementById('queueBadge');
            if (badge) {
                badge.textContent = state.queue.length;
                badge.classList.toggle('hidden', state.queue.length === 0);
            }
        }
        
        // Playback
        async function playTrack(index) {
            const track = state.allTracks[index];
            if (!track) return;
            
            const existing = state.queue.findIndex(t => t.id === track.id);
            if (existing === -1) {
                state.queue.push(track);
                state.currentIndex = state.queue.length - 1;
            } else {
                state.currentIndex = existing;
            }
            
            await loadAndPlay(track);
        }
        
        async function loadAndPlay(track) {
            state.currentTrack = track;
            
            ['mobileTitle', 'desktopTitle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = track.title;
            });
            ['mobileArtist', 'desktopArtist'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = track.artist;
            });
            
            ['mobileCover', 'desktopCover'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.src = track.cover || '';
                    el.classList.toggle('opacity-0', !track.cover);
                }
            });
            
            audio.src = track.url;
            audio.load();
            
            try {
                await audio.play();
                state.isPlaying = true;
                updatePlayButton();
                renderSongs();
                renderQueue();
            } catch (e) {
                setTimeout(nextTrack, 500);
            }
        }
        
        function togglePlay() {
            if (!state.currentTrack) {
                if (state.allTracks.length) playTrack(0);
                return;
            }
            
            if (state.isPlaying) {
                audio.pause();
                state.isPlaying = false;
            } else {
                audio.play();
                state.isPlaying = true;
            }
            updatePlayButton();
            renderSongs();
            renderQueue();
        }
        
        function updatePlayButton() {
            const icon = state.isPlaying ? 'pause' : 'play';
            const fill = state.isPlaying ? '' : 'fill-black ml-0.5';
            
            const mobileBtn = document.getElementById('mobilePlay');
            const desktopBtn = document.getElementById('desktopPlay');
            
            if (mobileBtn) mobileBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${fill}"></i>`;
            if (desktopBtn) desktopBtn.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 ${fill}"></i>`;
            
            const mobileCd = document.getElementById('mobileCd');
            const desktopCd = document.getElementById('desktopCd');
            if (mobileCd) mobileCd.classList.toggle('paused', !state.isPlaying);
            if (desktopCd) desktopCd.classList.toggle('paused', !state.isPlaying);
            
            lucide.createIcons();
        }
        
        function nextTrack() {
            if (!state.queue.length) return;
            
            let nextIdx;
            if (state.isShuffle) {
                nextIdx = Math.floor(Math.random() * state.queue.length);
            } else {
                nextIdx = (state.currentIndex + 1) % state.queue.length;
            }
            
            state.currentIndex = nextIdx;
            loadAndPlay(state.queue[nextIdx]);
        }
        
        function prevTrack() {
            if (!state.queue.length) return;
            state.currentIndex = (state.currentIndex - 1 + state.queue.length) % state.queue.length;
            loadAndPlay(state.queue[state.currentIndex]);
        }
        
        function toggleShuffle() {
            state.isShuffle = !state.isShuffle;
            const active = state.isShuffle ? 'text-white' : 'text-gray-600';
            const mobileBtn = document.getElementById('mobileShuffle');
            const desktopBtn = document.getElementById('desktopShuffle');
            if (mobileBtn) mobileBtn.className = `p-2 ${active}`;
            if (desktopBtn) desktopBtn.className = `p-2 hover:text-white ${active}`;
        }
        
        function toggleRepeat() {
            state.isRepeat = !state.isRepeat;
            const active = state.isRepeat ? 'text-white' : 'text-gray-600';
            const mobileBtn = document.getElementById('mobileRepeat');
            const desktopBtn = document.getElementById('desktopRepeat');
            if (mobileBtn) mobileBtn.className = `p-2 ${active}`;
            if (desktopBtn) desktopBtn.className = `p-2 hover:text-white ${active}`;
        }
        
        function setVolume(val) {
            state.volume = parseInt(val);
            state.isMuted = state.volume === 0;
            audio.volume = state.volume / 100;
            updateVolumeIcon();
        }
        
        function toggleMute() {
            if (state.isMuted) {
                state.isMuted = false;
                state.volume = state.volume || 75;
                audio.volume = state.volume / 100;
                document.getElementById('mobileVolume').value = state.volume;
                document.getElementById('desktopVolume').value = state.volume;
            } else {
                state.isMuted = true;
                audio.volume = 0;
                document.getElementById('mobileVolume').value = 0;
                document.getElementById('desktopVolume').value = 0;
            }
            updateVolumeIcon();
        }
        
        function updateVolumeIcon() {
            const icon = state.isMuted || state.volume === 0 ? 'volume-x' : state.volume < 50 ? 'volume-1' : 'volume-2';
            const color = state.isMuted ? 'text-red-500' : 'text-gray-500';
            
            const mobileBtn = document.getElementById('mobileMute');
            const desktopBtn = document.getElementById('desktopMute');
            
            if (mobileBtn) {
                mobileBtn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i>`;
                mobileBtn.className = `p-2 ${state.isMuted ? 'text-red-500' : ''}`;
            }
            if (desktopBtn) {
                desktopBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i>`;
                desktopBtn.className = `p-2 hover:text-white ${state.isMuted ? 'text-red-500' : 'text-gray-500'}`;
            }
            
            lucide.createIcons();
        }
        
        function seek(val) {
            if (audio.duration) {
                audio.currentTime = (val / 100) * audio.duration;
            }
        }
        
        function updateProgressUI(pct) {
            document.getElementById('mobileProgress').value = pct;
            document.getElementById('desktopProgress').value = pct;
        }
        
        function updateTimeUI() {
            const current = formatTime(audio.currentTime);
            const total = formatTime(audio.duration || 0);
            document.getElementById('mobileCurrent').textContent = current;
            document.getElementById('mobileTotal').textContent = total;
            document.getElementById('desktopCurrent').textContent = current;
            document.getElementById('desktopTotal').textContent = total;
        }
        
        function addToQueue(index) {
            const track = state.allTracks[index];
            if (state.queue.find(t => t.id === track.id)) {
                showToast('Already in queue');
                return;
            }
            state.queue.push(track);
            renderQueue();
            showToast('Added to queue');
        }
        
        function playFromQueue(index) {
            state.currentIndex = index;
            loadAndPlay(state.queue[index]);
        }
        
        function clearQueue() {
            state.queue = [];
            state.currentIndex = -1;
            state.currentTrack = null;
            state.isPlaying = false;
            audio.pause();
            updatePlayButton();
            renderQueue();
            showToast('Queue cleared');
        }
        
        function showQueue() {
            document.getElementById('queueModal').classList.remove('hidden');
        }
        
        function hideQueue() {
            document.getElementById('queueModal').classList.add('hidden');
        }
        
        // Immediate search oninput
        function search(query) {
            if (!query.trim()) {
                state.filteredTracks = [...state.allTracks];
            } else {
                const terms = query.toLowerCase().split(' ');
                state.filteredTracks = state.allTracks.filter(t => {
                    const text = (t.title + ' ' + t.artist).toLowerCase();
                    return terms.some(term => text.includes(term));
                });
            }
            // Re-sort by popularity after search
            state.filteredTracks.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
            renderSongs();
        }
        
        function filter(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black', 'active');
                btn.classList.add('bg-gray-900', 'text-gray-400');
            });
            event.target.classList.remove('bg-gray-900', 'text-gray-400');
            event.target.classList.add('bg-white', 'text-black', 'active');
            
            const queries = {
                'all': '',
                'chinese': '霂 銝剖 chinese cpop mandopop 冽唬憐 銋靚 蝝急',
                'kpop': 'kpop korean bts blackpink twice ive',
                'jpop': 'jpop japanese anime 交 yoasobi',
                'anime': 'anime opening ending ost 擛潛 餈 撌其犖 怠蔣',
                'soundtrack': 'soundtrack ost movie film score instrumental',
                'electronic': 'electronic edm house techno dance dubstep',
                'rock': 'rock alternative indie metal punk'
            };
            
            const query = queries[type] || '';
            const searchInput = document.getElementById('mobileSearch') || document.getElementById('desktopSearch');
            if (searchInput) {
                searchInput.value = type === 'all' ? '' : query;
                search(query);
            }
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(msg) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast fixed bottom-20 left-1/2 -translate-x-1/2 bg-white text-black px-4 py-2 rounded-full text-sm font-medium z-50 shadow-lg';
            toast.textContent = msg;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    if (e.shiftKey) nextTrack();
                    break;
                case 'ArrowLeft':
                    if (e.shiftKey) prevTrack();
                    break;
            }
        });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>