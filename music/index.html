<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #222;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }

        .main-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        @media (min-width: 1024px) {
            .main-layout {
                flex-direction: row;
            }
        }

        .player-panel {
            background: linear-gradient(180deg, #0a0a0a 0%, #000 100%);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        @media (max-width: 1023px) {
            .player-panel {
                min-height: 50vh;
                padding: 20px;
            }
        }

        @media (min-width: 1024px) {
            .player-panel {
                width: 400px;
                min-height: 100vh;
                position: fixed;
                left: 0;
                top: 0;
                border-right: 1px solid #111;
                padding: 40px;
            }
        }

        .library-panel {
            flex: 1;
            background: #000;
            padding: 20px;
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
            .library-panel {
                margin-left: 400px;
                min-height: 100vh;
                padding: 32px;
            }
        }

        .cd-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        @media (min-width: 768px) {
            .cd-wrapper {
                width: 280px;
                height: 280px;
            }
        }

        @media (min-width: 1024px) {
            .cd-wrapper {
                width: 320px;
                height: 320px;
                margin-bottom: 40px;
            }
        }

        .cd {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #111 0deg, #1a1a1a 20deg,
                #111 40deg, #222 60deg,
                #111 80deg, #1a1a1a 100deg,
                #111 120deg, #222 140deg,
                #111 160deg, #1a1a1a 180deg,
                #111 200deg, #222 220deg,
                #111 240deg, #1a1a1a 260deg,
                #111 280deg, #222 300deg,
                #111 320deg, #1a1a1a 340deg,
                #111 360deg
            );
            box-shadow: 
                0 0 0 3px #050505,
                0 0 0 4px #222,
                0 20px 50px rgba(0,0,0,1),
                inset 0 0 60px rgba(0,0,0,0.9);
            position: relative;
            animation: spin 3s linear infinite;
            animation-play-state: paused;
        }

        .cd.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .cd::before {
            content: '';
            position: absolute;
            inset: 15%;
            border-radius: 50%;
            background: #080808;
            border: 2px solid #222;
        }

        .cd::after {
            content: '';
            position: absolute;
            inset: 44%;
            border-radius: 50%;
            background: #000;
            border: 2px solid #1a1a1a;
        }

        .album-art {
            position: absolute;
            inset: 16%;
            width: 68%;
            height: 68%;
            left: 16%;
            top: 16%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .controls-area {
            width: 100%;
            max-width: 340px;
        }

        .progress-box {
            width: 100%;
            height: 5px;
            background: #111;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            margin: 16px 0 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-box:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 22px;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .ctrl-btn.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255px) {
            .library-panel {
                margin-left: 400px;
                min-height: 100vh;
                padding: 32px;
            }
        }

        .cd-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        @media (min-width: 768px) {
            .cd-wrapper {
                width: 280px;
                height: 280px;
            }
        }

        @media (min-width: 1024px) {
            .cd-wrapper {
                width: 320px;
                height: 320px;
                margin-bottom: 40px;
            }
        }

        .cd {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #111 0deg, #1a1a1a 20deg,
                #111 40deg, #222 60deg,
                #111 80deg, #1a1a1a 100deg,
                #111 120deg, #222 140deg,
                #111 160deg, #1a1a1a 180deg,
                #111 200deg, #222 220deg,
                #111 240deg, #1a1a1a 260deg,
                #111 280deg, #222 300deg,
                #111 320deg, #1a1a1a 340deg,
                #111 360deg
            );
            box-shadow: 
                0 0 0 3px #050505,
                0 0 0 4px #222,
                0 20px 50px rgba(0,0,0,1),
                inset 0 0 60px rgba(0,0,0,0.9);
            position: relative;
            animation: spin 3s linear infinite;
            animation-play-state: paused;
        }

        .cd.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .cd::before {
            content: '';
            position: absolute;
            inset: 15%;
            border-radius: 50%;
            background: #080808;
            border: 2px solid #222;
        }

        .cd::after {
            content: '';
            position: absolute;
            inset: 44%;
            border-radius: 50%;
            background: #000;
            border: 2px solid #1a1a1a;
        }

        .album-art {
            position: absolute;
            inset: 16%;
            width: 68%;
            height: 68%;
            left: 16%;
            top: 16%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .controls-area {
            width: 100%;
            max-width: 340px;
        }

        .progress-box {
            width: 100%;
            height: 5px;
            background: #111;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            margin: 16px 0 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-box:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 22px;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .ctrl-btn.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .vol-section {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 0 4px;
        }

        .vol-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .vol-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .vol-btn.muted {
            color: #ff4444;
        }

        .vol-slider-container {
            flex: 1;
            height: 36px;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .vol-track {
            width: 100%;
            height: 4px;
            background: #111;
            border-radius: 2px;
            position: relative;
            pointer-events: none;
        }

        .vol-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 75%;
            pointer-events: none;
            position: relative;
            transition: width 0.05s linear, background-color 0.2s;
        }

        .vol-fill.muted {
            background: #333;
        }

        .vol-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .vol-slider-container:hover .vol-handle,
        .vol-handle.dragging {
            opacity: 1;
        }

        .vol-handle.muted {
            background: #666;
        }

        .vol-text {
            font-size: 11px;
            color: #444;
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .vol-text.muted {
            color: #ff4444;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 44px 14px 44px;
            border-radius: 12px;
            border: 1px solid #111;
            background: #050505;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #222;
            background: #080808;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
            font-size: 18px;
        }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            display: none;
        }

        .clear-btn.visible {
            display: block;
        }

        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 24px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #111;
            background: transparent;
            color: #444;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .section-title {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }

        .track-card:hover {
            background: #050505;
        }

        .track-card.active {
            background: #080808;
            border-left-color: #fff;
        }

        .track-card.playing {
            background: #0a0a0a;
        }

        .track-img {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #080808;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .track-title {
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .track-meta {
            font-size: 11px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #222;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s;
            font-size: 18px;
        }

        .track-card:hover .track-action {
            opacity: 1;
        }

        .track-action:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .queue-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #080808;
        }

        .songs-section {
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #1a1a1a;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .empty-state i {
            font-size: 40px;
            color: #111;
        }

        .skeleton {
            background: linear-gradient(90deg, #050505 25%, #080808 50%, #050505 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 10px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .error-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .now-playing-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            width: 16px;
            height: 16px;
        }

        .bar {
            width: 3px;
            background: #fff;
            border-radius: 1px;
            animation: equalizer 0.8s ease-in-out infinite;
        }

        .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .bar:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .bar:nth-child(3) { height: 8px; animation-delay: 0.3s; }

        @keyframes equalizer {
            0%, 100% { transform: scaleY(0.6); }
            50% { transform: scaleY(1); }
        }

        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(5,5,5,0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #111;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .mini-player.visible {
            transform: translateY(0);
        }

        .mini-cover {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
        }

        .mini-info {
            flex: 1;
            min-width: 0;
        }

        .mini-title {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-artist {
            font-size: 11px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            gap: 8px;
        }

        .mini-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .mini-play {
            background: #fff;
            color: #000;
        }

        @media (min-width: 1024px) {
            .mini-player {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast"><i class="ph ph-check"></i><span id="toastText">Notification</span></div>
    <div class="error-indicator" id="errorIndicator"><i class="ph ph-warning"></i><span>Error</span></div>

    <div class="mini-player" id="miniPlayer">
        <img class="mini-cover" id="miniCover" src="" alt="">
        <div class="mini-info">
            <div class="mini-title" id="miniTitle">Select a song</div>
            <div class="mini-artist" id="miniArtist">Choose from library</div>
        </div>
        <div class="mini-controls">
            <button class="mini-btn" onclick="prevTrack()"><i class="ph ph-skip-back"></i></button>
            <button class="mini-btn mini-play" onclick="togglePlay()" id="miniPlayBtn"><i class="ph ph-play"></i></button>
            <button class="mini-btn" onclick="nextTrack()"><i class="ph ph-skip-forward"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <div class="player-panel">
            <div class="cd-wrapper">
                <div class="cd" id="cd">
                    <img id="coverArt" class="album-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23050505'/%3E%3Ccircle cx='100' cy='100' r='40' fill='%23080808'/%3E%3C/svg%3E" alt="">
                </div>
            </div>

            <div style="text-align: center; width: 100%; margin-bottom: 24px;">
                <h1 id="trackTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 6px; padding: 0 10px;">Select a song</h1>
                <p id="trackArtist" style="font-size: 13px; color: #333; margin-bottom: 8px;">Choose from library</p>
                <span id="sourceBadge" style="font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 0.1em;">Ready</span>
            </div>

            <div class="controls-area">
                <div class="progress-box" id="progressBox">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="btn-row">
                    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
                        <i class="ph ph-shuffle"></i>
                    </button>
                    <button class="ctrl-btn" onclick="prevTrack()" title="Previous">
                        <i class="ph ph-skip-back"></i>
                    </button>
                    <button class="play-btn" onclick="togglePlay()" id="playBtn">
                        <i class="ph ph-play" id="playIcon"></i>
                    </button>
                    <button class="ctrl-btn" onclick="nextTrack()" title="Next">
                        <i class="ph ph-skip-forward"></i>
                    </button>
                    <button class="ctrl-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">
                        <i class="ph ph-repeat"></i>
                    </button>
                </div>

                <div class="vol-section">
                    <button class="vol-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                        <i class="ph ph-speaker-high" id="volIcon"></i>
                    </button>
                    <div class="vol-slider-container" id="volSliderContainer">
                        <div class="vol-track">
                            <div class="vol-fill" id="volFill">
                                <div class="vol-handle" id="volHandle"></div>
                            </div>
                        </div>
                    </div>
                    <span class="vol-text" id="volText">75%</span>
                </div>
            </div>
        </div>

        <div class="library-panel">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists..." oninput="onSearch(this.value)">
                <button class="clear-btn" id="clearBtn" onclick="clearSearch()"><i class="ph ph-x"></i></button>
            </div>

            <div class="filter-scroll">
                <button class="filter-chip active" onclick="setFilter('all', this)"><i class="ph ph-fire"></i> All</button>
                <button class="filter-chip" onclick="setFilter('mandopop', this)"><i class="ph ph-music-notes"></i> 华语</button>
                <button class="filter-chip" onclick="setFilter('cantopop', this)"><i class="ph ph-vinyl-record"></i> 粤语</button>
                <button class="filter-chip" onclick="setFilter('kpop', this)"><i class="ph ph-star"></i> K-Pop</button>
                <button class="filter-chip" onclick="setFilter('jpop', this)"><i class="ph ph-piano-keys"></i> J-Pop</button>
                <buttonpx) {
            .library-panel {
                margin-left: 400px;
                min-height: 100vh;
                padding: 32px;
            }
        }

        .cd-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        @media (min-width: 768px) {
            .cd-wrapper {
                width: 280px;
                height: 280px;
            }
        }

        @media (min-width: 1024px) {
            .cd-wrapper {
                width: 320px;
                height: 320px;
                margin-bottom: 40px;
            }
        }

        .cd {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #111 0deg, #1a1a1a 20deg,
                #111 40deg, #222 60deg,
                #111 80deg, #1a1a1a 100deg,
                #111 120deg, #222 140deg,
                #111 160deg, #1a1a1a 180deg,
                #111 200deg, #222 220deg,
                #111 240deg, #1a1a1a 260deg,
                #111 280deg, #222 300deg,
                #111 320deg, #1a1a1a 340deg,
                #111 360deg
            );
            box-shadow: 
                0 0 0 3px #050505,
                0 0 0 4px #222,
                0 20px 50px rgba(0,0,0,1),
                inset 0 0 60px rgba(0,0,0,0.9);
            position: relative;
            animation: spin 3s linear infinite;
            animation-play-state: paused;
        }

        .cd.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .cd::before {
            content: '';
            position: absolute;
            inset: 15%;
            border-radius: 50%;
            background: #080808;
            border: 2px solid #222;
        }

        .cd::after {
            content: '';
            position: absolute;
            inset: 44%;
            border-radius: 50%;
            background: #000;
            border: 2px solid #1a1a1a;
        }

        .album-art {
            position: absolute;
            inset: 16%;
            width: 68%;
            height: 68%;
            left: 16%;
            top: 16%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .controls-area {
            width: 100%;
            max-width: 340px;
        }

        .progress-box {
            width: 100%;
            height: 5px;
            background: #111;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            margin: 16px 0 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-box:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 22px;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .ctrl-btn.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .vol-section {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 0 4px;
        }

        .vol-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .vol-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .vol-btn.muted {
            color: #ff4444;
        }

        .vol-slider-container {
            flex: 1;
            height: 36px;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .vol-track {
            width: 100%;
            height: 4px;
            background: #111;
            border-radius: 2px;
            position: relative;
            pointer-events: none;
        }

        .vol-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 75%;
            pointer-events: none;
            position: relative;
            transition: width 0.05s linear, background-color 0.2s;
        }

        .vol-fill.muted {
            background: #333;
        }

        .vol-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .vol-slider-container:hover .vol-handle,
        .vol-handle.dragging {
            opacity: 1;
        }

        .vol-handle.muted {
            background: #666;
        }

        .vol-text {
            font-size: 11px;
            color: #444;
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .vol-text.muted {
            color: #ff4444;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 44px 14px 44px;
            border-radius: 12px;
            border: 1px solid #111;
            background: #050505;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #222;
            background: #080808;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
            font-size: 18px;
        }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            display: none;
        }

        .clear-btn.visible {
            display: block;
        }

        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 24px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #111;
            background: transparent;
            color: #444;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .section-title {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }

        .track-card:hover {
            background: #050505;
        }

        .track-card.active {
            background: #080808;
            border-left-color: #fff;
        }

        .track-card.playing {
            background: #0a0a0a;
        }

        .track-img {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #080808;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .track-title {
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .track-meta {
            font-size: 11px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #222;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s;
            font-size: 18px;
        }

        .track-card:hover .track-action {
            opacity: 1;
        }

        .track-action:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .queue-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #080808;
        }

        .songs-section {
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #1a1a1a;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .empty-state i {
            font-size: 40px;
            color: #111;
        }

        .skeleton {
            background: linear-gradient(90deg, #050505 25%, #080808 50%, #050505 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 10px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .error-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .now-playing-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            width: 16px;
            height: 16px;
        }

        .bar {
            width: 3px;
            background: #fff;
            border-radius: 1px;
            animation: equalizer 0.8s ease-in-out infinite;
        }

        .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .bar:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .bar:nth-child(3) { height: 8px; animation-delay: 0.3s; }

        @keyframes equalizer {
            0%, 100% { transform: scaleY(0.6); }
            50% { transform: scaleY(1); }
        }

        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(5,5,5,0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #111;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .mini-player.visible {
            transform: translateY(0);
        }

        .mini-cover {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
        }

        .mini-info {
            flex: 1;
            min-width: 0;
        }

        .mini-title {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-artist {
            font-size: 11px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            gap: 8px;
        }

        .mini-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .mini-play {
            background: #fff;
            color: #000;
        }

        @media (min-width: 1024px) {
            .mini-player {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast"><i class="ph ph-check"></i><span id="toastText">Notification</span></div>
    <div class="error-indicator" id="errorIndicator"><i class="ph ph-warning"></i><span>Error</span></div>

    <div class="mini-player" id="miniPlayer">
        <img class="mini-cover" id="miniCover" src="" alt="">
        <div class="mini-info">
            <div class="mini-title" id="miniTitle">Select a song</div>
            <div class="mini-artist" id="miniArtist">Choose from library</div>
        </div>
        <div class="mini-controls">
            <button class="mini-btn" onclick="prevTrack()"><i class="ph ph-skip-back"></i></button>
            <button class="mini-btn mini-play" onclick="togglePlay()" id="miniPlayBtn"><i class="ph ph-play"></i></button>
            <button class="mini-btn" onclick="nextTrack()"><i class="ph ph-skip-forward"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <div class="player-panel">
            <div class="cd-wrapper">
                <div class="cd" id="cd">
                    <img id="coverArt" class="album-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23050505'/%3E%3Ccircle cx='100' cy='100' r='40' fill='%23080808'/%3E%3C/svg%3E" alt="">
                </div>
            </div>

            <div style="text-align: center; width: 100%; margin-bottom: 24px;">
                <h1 id="trackTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 6px; padding: 0 10px;">Select a song</h1>
                <p id="trackArtist" style="font-size: 13px; color: #333; margin-bottom: 8px;">Choose from library</p>
                <span id="sourceBadge" style="font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 0.1em;">Ready</span>
            </div>

            <div class="controls-area">
                <div class="progress-box" id="progressBox">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="btn-row">
                    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
                        <i class="ph ph-shuffle"></i>
                    </button>
                    <button class="ctrl-btn" onclick="prevTrack()" title="Previous">
                        <i class="ph ph-skip-back"></i>
                    </button>
                    <button class="play-btn" onclick="togglePlay()" id="playBtn">
                        <i class="ph ph-play" id="playIcon"></i>
                    </button>
                    <button class="ctrl-btn" onclick="nextTrack()" title="Next">
                        <i class="ph ph-skip-forward"></i>
                    </button>
                    <button class="ctrl-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">
                        <i class="ph ph-repeat"></i>
                    </button>
                </div>

                <div class="vol-section">
                    <button class="vol-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                        <i class="ph ph-speaker-high" id="volIcon"></i>
                    </button>
                    <div class="vol-slider-container" id="volSliderContainer">
                        <div class="vol-track">
                            <div class="vol-fill" id="volFill">
                                <div class="vol-handle" id="volHandle"></div>
                            </div>
                        </div>
                    </div>
                    <span class="vol-text" id="volText">75%</span>
                </div>
            </div>
        </div>

        <div class="library-panel">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists..." oninput="onSearch(this.value)">
                <button class="clear-btn" id="clearBtn" onclick="clearSearch()"><i class="ph ph-x"></i></button>
            </div>

            <div class="filter-scroll">
                <button class="filter-chip active" onclick="setFilter('all', this)"><i class="ph ph-fire"></i> All</button>
                <button class="filter-chip" onclick="setFilter('mandopop', this)"><i class="ph ph-music-notes"></i> 华语</button>
                <button class="filter-chip" onclick="setFilter('cantopop', this)"><i class="ph ph-vinyl-record"></i> 粤语</button>
                <button class="filter-chip" onclick="setFilter('kpop', this)"><i class="ph ph-star"></i> K-Pop</button>
                <button class="filter-chip" onclick="setFilter('jpop', this)"><i class="ph ph-piano-keys"></i> J-Pop</button>
                <button class="filter-chip" onclick="setFilter('anime', this)"><i class="ph ph-television"></i> Anime</button>
                <button class="filter-chip" onclick="setFilter('bollywood', this)"><i class="ph ph-film-strip"></i> Bollywood</button>
                <button class="filter-chip" onclick="setFilter('thai', this)"><i class="ph ph-temple"></i> Thai</button>
                <button class="filter-chip" onclick="setFilter('vietnamese', this)"><i class="ph ph-coffee"></i> V-Pop</button>
                <button class="filter-chip" onclick="setFilter('indonesian', this)"><i class="ph ph-island"></i> Indo</button>
                <button class="filter-chip" onclick="setFilter('philippines', this)"><i class="ph ph-sun"></i> OPM</button>
                <button class="filter-chip" onclick="setFilter('electronic', this)"><i class="ph ph-speaker-hifi"></i> Electronic</button>
                <button class="filter-chip" onclick="setFilter('rock', this)"><i class="ph ph-guitar"></i> Rock</button>
                <button class="filter-chip" onclick="setFilter('classical', this)"><i class="ph ph-violin"></i> Classical</button>
                <button class="filter-chip" onclick="setFilter('lofi', this)"><i class="ph ph-coffee"></i> Lo-Fi</button>
                <button class="filter-chip" onclick="setFilter('jazz', this)"><i class="ph ph-saxophone"></i> Jazz</button>
                <button class="filter-chip" onclick="setFilter('folk', this)"><i class="ph ph-tree-palm"></i> Folk</button>
                <button class="filter-chip" onclick="setFilter('metal', this)"><i class="ph ph-lightning"></i> Metal</button>
                <button class="filter-chip" onclick="setFilter('ambient', this)"><i class="ph ph-cloud"></i> Ambient</button>
                <button class="filter-chip" onclick="setFilter('reggae', this)"><i class="ph ph-sun-horizon"></i> Reggae</button>
                <button class="filter-chip" onclick="setFilter('latin', this)"><i class="ph ph-music-note"></i> Latin</button>
                <button class="filter-chip" onclick="setFilter('african', this)"><i class="ph ph-drums"></i> Afro</button>
                <button class="filter-chip" onclick="setFilter('middleeastern', this)"><i class="ph ph-moon"></i> Arabic</button>
                <button class="filter-chip" onclick="setFilter('turkish', this)"><i class="ph ph-mosque"></i> Turkish</button>
                <button class="filter-chip" onclick="setFilter('russian', this)"><i class="ph ph-snowflake"></i> Russian</button>
                <button class="filter-chip" onclick="setFilter('brazilian', this)"><i class="ph ph-soccer-ball"></i> Brazilian</button>
            </div>

            <div class="queue-section">
                <div class="section-title">
                    <span><i class="ph ph-queue" style="margin-right:6px"></i>Queue</span>
                    <span id="queueCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="queueList">
                    <div class="empty-state">
                        <i class="ph ph-queue"></i>
                        <div>Queue empty</div>
                    </div>
                </div>
            </div>

            <div class="songs-section">
                <div class="section-title">
                    <span><i class="ph ph-music-notes" style="margin-right:6px"></i>Songs</span>
                    <span id="resultCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="trackList">
                    <div class="empty-state">
                        <i class="ph ph-spinner animate-spin"></i>
                        <div>Loading...</div>
                    </div>
                </div>
            </div>

            <div style="height:100px"></div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous" preload="metadata" style="display:none"></audio>

    <script>
        const state = {
            currentTrack: null,
            isPlaying: false,
            queue: [],
            currentIndex: -1,
            isShuffle: false,
            isRepeat: false,
            volume: 75,
            lastVolume: 75,
            isMuted: false,
            searchResults: [],
            failedTracks: new Set()
        };

        const audio = document.getElementById('audioPlayer');
        const cd = document.getElementById('cd');

        window.onload = () => {
            audio.volume = 0.75;
            setupAudioEvents();
            setupVolumeControl();
            loadAllSources();
        };

        function setupAudioEvents() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', handleEnded);
            audio.addEventListener('error', handleError);
            audio.addEventListener('canplay', () => hideError());
            audio.addEventListener('loadedmetadata', () => {
                document.getElementById('totalTime').textContent = formatTime(audio.duration);
            });
            document.getElementById('progressBox').addEventListener('click', seek);
        }

        function updateProgress() {
            if (audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFill').style.width = pct + '%';
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            }
        }

        function seek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if (audio.duration) audio.currentTime = pct * audio.duration;
        }

        function handleEnded() {
            if (state.isRepeat) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } else {
                nextTrack();
            }
        }

        function handleError(e) {
            console.error('Audio error:', e);
            if (state.currentTrack) {
                state.failedTracks.add(state.currentTrack.id);
                showError('Track unavailable');
                setTimeout(() => nextTrack(), 1500);
            }
        }

        function setupVolumeControl() {
            const container = document.getElementById('volSliderContainer');
            const fill = document.getElementById('volFill');
            const handle = document.getElementById('volHandle');
            const text = document.getElementById('volText');
            const btn = document.getElementById('muteBtn');
            const icon = document.getElementById('volIcon');

            let isDragging = false;

            function updateVolume(clientX) {
                const rect = container.getBoundingClientRect();
                let pct = (clientX - rect.left) / rect.width;
                pct = Math.max(0, Math.min(1, pct));
                const vol = Math.round(pct * 100);
                
                if (vol === 0) {
                    state.isMuted = true;
                    audio.volume = 0;
                } else {
                    state.isMuted = false;
                    audio.volume = vol / 100;
                    state.volume = vol;
                }
                updateVolUI();
            }

            function updateVolUI() {
                const displayVol = state.isMuted ? 0 : state.volume;
                fill.style.width = displayVol + '%';
                text.textContent = displayVol + '%';
                
                if (state.isMuted || state.volume === 0) {
                    icon.className = 'ph ph-speaker-x';
                    btn.classList.add('muted');
                    fill.classList.add('muted');
                    handle.classList.add('muted');
                    text.classList.add('muted');
                } else if (state.volume < 30)px) {
            .library-panel {
                margin-left: 400px;
                min-height: 100vh;
                padding: 32px;
            }
        }

        .cd-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        @media (min-width: 768px) {
            .cd-wrapper {
                width: 280px;
                height: 280px;
            }
        }

        @media (min-width: 1024px) {
            .cd-wrapper {
                width: 320px;
                height: 320px;
                margin-bottom: 40px;
            }
        }

        .cd {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #111 0deg, #1a1a1a 20deg,
                #111 40deg, #222 60deg,
                #111 80deg, #1a1a1a 100deg,
                #111 120deg, #222 140deg,
                #111 160deg, #1a1a1a 180deg,
                #111 200deg, #222 220deg,
                #111 240deg, #1a1a1a 260deg,
                #111 280deg, #222 300deg,
                #111 320deg, #1a1a1a 340deg,
                #111 360deg
            );
            box-shadow: 
                0 0 0 3px #050505,
                0 0 0 4px #222,
                0 20px 50px rgba(0,0,0,1),
                inset 0 0 60px rgba(0,0,0,0.9);
            position: relative;
            animation: spin 3s linear infinite;
            animation-play-state: paused;
        }

        .cd.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .cd::before {
            content: '';
            position: absolute;
            inset: 15%;
            border-radius: 50%;
            background: #080808;
            border: 2px solid #222;
        }

        .cd::after {
            content: '';
            position: absolute;
            inset: 44%;
            border-radius: 50%;
            background: #000;
            border: 2px solid #1a1a1a;
        }

        .album-art {
            position: absolute;
            inset: 16%;
            width: 68%;
            height: 68%;
            left: 16%;
            top: 16%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .controls-area {
            width: 100%;
            max-width: 340px;
        }

        .progress-box {
            width: 100%;
            height: 5px;
            background: #111;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            margin: 16px 0 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-box:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 22px;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .ctrl-btn.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .vol-section {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 0 4px;
        }

        .vol-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .vol-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .vol-btn.muted {
            color: #ff4444;
        }

        .vol-slider-container {
            flex: 1;
            height: 36px;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .vol-track {
            width: 100%;
            height: 4px;
            background: #111;
            border-radius: 2px;
            position: relative;
            pointer-events: none;
        }

        .vol-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 75%;
            pointer-events: none;
            position: relative;
            transition: width 0.05s linear, background-color 0.2s;
        }

        .vol-fill.muted {
            background: #333;
        }

        .vol-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .vol-slider-container:hover .vol-handle,
        .vol-handle.dragging {
            opacity: 1;
        }

        .vol-handle.muted {
            background: #666;
        }

        .vol-text {
            font-size: 11px;
            color: #444;
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .vol-text.muted {
            color: #ff4444;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 44px 14px 44px;
            border-radius: 12px;
            border: 1px solid #111;
            background: #050505;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #222;
            background: #080808;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
            font-size: 18px;
        }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            display: none;
        }

        .clear-btn.visible {
            display: block;
        }

        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 24px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #111;
            background: transparent;
            color: #444;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .section-title {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }

        .track-card:hover {
            background: #050505;
        }

        .track-card.active {
            background: #080808;
            border-left-color: #fff;
        }

        .track-card.playing {
            background: #0a0a0a;
        }

        .track-img {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #080808;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .track-title {
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .track-meta {
            font-size: 11px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #222;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s;
            font-size: 18px;
        }

        .track-card:hover .track-action {
            opacity: 1;
        }

        .track-action:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .queue-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #080808;
        }

        .songs-section {
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #1a1a1a;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .empty-state i {
            font-size: 40px;
            color: #111;
        }

        .skeleton {
            background: linear-gradient(90deg, #050505 25%, #080808 50%, #050505 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 10px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .error-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .now-playing-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            width: 16px;
            height: 16px;
        }

        .bar {
            width: 3px;
            background: #fff;
            border-radius: 1px;
            animation: equalizer 0.8s ease-in-out infinite;
        }

        .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .bar:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .bar:nth-child(3) { height: 8px; animation-delay: 0.3s; }

        @keyframes equalizer {
            0%, 100% { transform: scaleY(0.6); }
            50% { transform: scaleY(1); }
        }

        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(5,5,5,0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #111;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .mini-player.visible {
            transform: translateY(0);
        }

        .mini-cover {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
        }

        .mini-info {
            flex: 1;
            min-width: 0;
        }

        .mini-title {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-artist {
            font-size: 11px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            gap: 8px;
        }

        .mini-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .mini-play {
            background: #fff;
            color: #000;
        }

        @media (min-width: 1024px) {
            .mini-player {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast"><i class="ph ph-check"></i><span id="toastText">Notification</span></div>
    <div class="error-indicator" id="errorIndicator"><i class="ph ph-warning"></i><span>Error</span></div>

    <div class="mini-player" id="miniPlayer">
        <img class="mini-cover" id="miniCover" src="" alt="">
        <div class="mini-info">
            <div class="mini-title" id="miniTitle">Select a song</div>
            <div class="mini-artist" id="miniArtist">Choose from library</div>
        </div>
        <div class="mini-controls">
            <button class="mini-btn" onclick="prevTrack()"><i class="ph ph-skip-back"></i></button>
            <button class="mini-btn mini-play" onclick="togglePlay()" id="miniPlayBtn"><i class="ph ph-play"></i></button>
            <button class="mini-btn" onclick="nextTrack()"><i class="ph ph-skip-forward"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <div class="player-panel">
            <div class="cd-wrapper">
                <div class="cd" id="cd">
                    <img id="coverArt" class="album-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23050505'/%3E%3Ccircle cx='100' cy='100' r='40' fill='%23080808'/%3E%3C/svg%3E" alt="">
                </div>
            </div>

            <div style="text-align: center; width: 100%; margin-bottom: 24px;">
                <h1 id="trackTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 6px; padding: 0 10px;">Select a song</h1>
                <p id="trackArtist" style="font-size: 13px; color: #333; margin-bottom: 8px;">Choose from library</p>
                <span id="sourceBadge" style="font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 0.1em;">Ready</span>
            </div>

            <div class="controls-area">
                <div class="progress-box" id="progressBox">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="btn-row">
                    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
                        <i class="ph ph-shuffle"></i>
                    </button>
                    <button class="ctrl-btn" onclick="prevTrack()" title="Previous">
                        <i class="ph ph-skip-back"></i>
                    </button>
                    <button class="play-btn" onclick="togglePlay()" id="playBtn">
                        <i class="ph ph-play" id="playIcon"></i>
                    </button>
                    <button class="ctrl-btn" onclick="nextTrack()" title="Next">
                        <i class="ph ph-skip-forward"></i>
                    </button>
                    <button class="ctrl-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">
                        <i class="ph ph-repeat"></i>
                    </button>
                </div>

                <div class="vol-section">
                    <button class="vol-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                        <i class="ph ph-speaker-high" id="volIcon"></i>
                    </button>
                    <div class="vol-slider-container" id="volSliderContainer">
                        <div class="vol-track">
                            <div class="vol-fill" id="volFill">
                                <div class="vol-handle" id="volHandle"></div>
                            </div>
                        </div>
                    </div>
                    <span class="vol-text" id="volText">75%</span>
                </div>
            </div>
        </div>

        <div class="library-panel">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists..." oninput="onSearch(this.value)">
                <button class="clear-btn" id="clearBtn" onclick="clearSearch()"><i class="ph ph-x"></i></button>
            </div>

            <div class="filter-scroll">
                <button class="filter-chip active" onclick="setFilter('all', this)"><i class="ph ph-fire"></i> All</button>
                <button class="filter-chip" onclick="setFilter('mandopop', this)"><i class="ph ph-music-notes"></i> 华语</button>
                <button class="filter-chip" onclick="setFilter('cantopop', this)"><i class="ph ph-vinyl-record"></i> 粤语</button>
                <button class="filter-chip" onclick="setFilter('kpop', this)"><i class="ph ph-star"></i> K-Pop</button>
                <button class="filter-chip" onclick="setFilter('jpop', this)"><i class="ph ph-piano-keys"></i> J-Pop</button>
                <button class="filter-chip" onclick="setFilter('anime', this)"><i class="ph ph-television"></i> Anime</button>
                <button class="filter-chip" onclick="setFilter('bollywood', this)"><i class="ph ph-film-strip"></i> Bollywood</button>
                <button class="filter-chip" onclick="setFilter('thai', this)"><i class="ph ph-temple"></i> Thai</button>
                <button class="filter-chip" onclick="setFilter('vietnamese', this)"><i class="ph ph-coffee"></i> V-Pop</button>
                <button class="filter-chip" onclick="setFilter('indonesian', this)"><i class="ph ph-island"></i> Indo</button>
                <button class="filter-chip" onclick="setFilter('philippines', this)"><i class="ph ph-sun"></i> OPM</button>
                <button class="filter-chip" onclick="setFilter('electronic', this)"><i class="ph ph-speaker-hifi"></i> Electronic</button>
                <button class="filter-chip" onclick="setFilter('rock', this)"><i class="ph ph-guitar"></i> Rock</button>
                <button class="filter-chip" onclick="setFilter('classical', this)"><i class="ph ph-violin"></i> Classical</button>
                <button class="filter-chip" onclick="setFilter('lofi', this)"><i class="ph ph-coffee"></i> Lo-Fi</button>
                <button class="filter-chip" onclick="setFilter('jazz', this)"><i class="ph ph-saxophone"></i> Jazz</button>
                <button class="filter-chip" onclick="setFilter('folk', this)"><i class="ph ph-tree-palm"></i> Folk</button>
                <button class="filter-chip" onclick="setFilter('metal', this)"><i class="ph ph-lightning"></i> Metal</button>
                <button class="filter-chip" onclick="setFilter('ambient', this)"><i class="ph ph-cloud"></i> Ambient</button>
                <button class="filter-chip" onclick="setFilter('reggae', this)"><i class="ph ph-sun-horizon"></i> Reggae</button>
                <button class="filter-chip" onclick="setFilter('latin', this)"><i class="ph ph-music-note"></i> Latin</button>
                <button class="filter-chip" onclick="setFilter('african', this)"><i class="ph ph-drums"></i> Afro</button>
                <button class="filter-chip" onclick="setFilter('middleeastern', this)"><i class="ph ph-moon"></i> Arabic</button>
                <button class="filter-chip" onclick="setFilter('turkish', this)"><i class="ph ph-mosque"></i> Turkish</button>
                <button class="filter-chip" onclick="setFilter('russian', this)"><i class="ph ph-snowflake"></i> Russian</button>
                <button class="filter-chip" onclick="setFilter('brazilian', this)"><i class="ph ph-soccer-ball"></i> Brazilian</button>
            </div>

            <div class="queue-section">
                <div class="section-title">
                    <span><i class="ph ph-queue" style="margin-right:6px"></i>Queue</span>
                    <span id="queueCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="queueList">
                    <div class="empty-state">
                        <i class="ph ph-queue"></i>
                        <div>Queue empty</div>
                    </div>
                </div>
            </div>

            <div class="songs-section">
                <div class="section-title">
                    <span><i class="ph ph-music-notes" style="margin-right:6px"></i>Songs</span>
                    <span id="resultCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="trackList">
                    <div class="empty-state">
                        <i class="ph ph-spinner animate-spin"></i>
                        <div>Loading...</div>
                    </div>
                </div>
            </div>

            <div style="height:100px"></div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous" preload="metadata" style="display:none"></audio>

    <script>
        const state = {
            currentTrack: null,
            isPlaying: false,
            queue: [],
            currentIndex: -1,
            isShuffle: false,
            isRepeat: false,
            volume: 75,
            lastVolume: 75,
            isMuted: false,
            searchResults: [],
            failedTracks: new Set()
        };

        const audio = document.getElementById('audioPlayer');
        const cd = document.getElementById('cd');

        window.onload = () => {
            audio.volume = 0.75;
            setupAudioEvents();
            setupVolumeControl();
            loadAllSources();
        };

        function setupAudioEvents() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', handleEnded);
            audio.addEventListener('error', handleError);
            audio.addEventListener('canplay', () => hideError());
            audio.addEventListener('loadedmetadata', () => {
                document.getElementById('totalTime').textContent = formatTime(audio.duration);
            });
            document.getElementById('progressBox').addEventListener('click', seek);
        }

        function updateProgress() {
            if (audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFill').style.width = pct + '%';
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            }
        }

        function seek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if (audio.duration) audio.currentTime = pct * audio.duration;
        }

        function handleEnded() {
            if (state.isRepeat) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } else {
                nextTrack();
            }
        }

        function handleError(e) {
            console.error('Audio error:', e);
            if (state.currentTrack) {
                state.failedTracks.add(state.currentTrack.id);
                showError('Track unavailable');
                setTimeout(() => nextTrack(), 1500);
            }
        }

        function setupVolumeControl() {
            const container = document.getElementById('volSliderContainer');
            const fill = document.getElementById('volFill');
            const handle = document.getElementById('volHandle');
            const text = document.getElementById('volText');
            const btn = document.getElementById('muteBtn');
            const icon = document.getElementById('volIcon');

            let isDragging = false;

            function updateVolume(clientX) {
                const rect = container.getBoundingClientRect();
                let pct = (clientX - rect.left) / rect.width;
                pct = Math.max(0, Math.min(1, pct));
                const vol = Math.round(pct * 100);
                
                if (vol === 0) {
                    state.isMuted = true;
                    audio.volume = 0;
                } else {
                    state.isMuted = false;
                    audio.volume = vol / 100;
                    state.volume = vol;
                }
                updateVolUI();
            }

            function updateVolUI() {
                const displayVol = state.isMuted ? 0 : state.volume;
                fill.style.width = displayVol + '%';
                text.textContent = displayVol + '%';
                
                if (state.isMuted || state.volume === 0) {
                    icon.className = 'ph ph-speaker-x';
                    btn.classList.add('muted');
                    fill.classList.add('muted');
                    handle.classList.add('muted');
                    text.classList.add('muted');
                } else if (state.volume < 30) {
                    icon.className = 'ph ph-speaker-low';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                } else if (state.volume < 70) {
                    icon.className = 'ph ph-speaker-medium';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                } else {
                    icon.className = 'ph ph-speaker-high';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                }
            }

            container.addEventListener('click', (e) => {
                if (!isDragging) updateVolume(e.clientX);
            });

            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                handle.classList.add('dragging');
                updateVolume(e.clientX);
                
                const moveHandler = (e) => {
                    if (isDragging) updateVolume(e.clientX);
                };
                
                const upHandler = () => {
                    isDragging = false;
                    handle.classList.remove('dragging');
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            });

            container.addEventListener('touchstart', (e) => {
                isDragging = true;
                handle.classList.add('dragging');
                updateVolume(e.touches[0].clientX);
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    updateVolume(e.touches[0].clientX);
                }
            }, { passive: false });

            container.addEventListener('touchend', () => {
                isDragging = false;
                handle.classList.remove('dragging');
            });

            state.updateVolUI = updateVolUI;
            updateVolUI();
        }

        function toggleMute() {
            if (state.isMuted) {
                const restore = state.lastVolume > 0 ? state.lastVolume : 75;
                state.isMuted = false;
                state.volume = restore;
                audio.volume = restore / 100;
            } else {
                state.lastVolume = state.volume;
                state.isMuted = true;
                audio.volume = 0;
            }
            if (state.updateVolUI) state.updateVolUI();
        }

        let searchTimer;
        function onSearch(val) {
            document.getElementById('clearBtn').classList.toggle('visible', val.length > 0);
            clearTimeout(searchTimer);
            if (val.length < 2) {
                if (val.length === 0) loadAllSources();
                return;
            }
            searchTimer = setTimeout(() => searchAll(val), 300);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').classList.remove('visible');
            loadAllSources();
        }

        function setFilter(type, btn) {
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const queries = {
                'all': 'popular music',
                'mandopop': '华语流行 周杰伦 薛之谦 邓紫棋 林俊杰 李荣浩 毛不易 周深',
                'cantopop': '粤语 陈奕迅 Beyond 王菲 张学友 李克勤 邓紫棋 杨千嬅',
                'kpop': 'K-Pop BTS BLACKPINK TWICE IVE NewJeans SEVENTEEN',
                'jpop': 'J-Pop YOASOBI Official髭男dism Ado LiSA Aimer RADWIMPS',
                'anime': 'anime opening ending OST 鬼滅の刃 進撃の巨人 ワンピース',
                'bollywood': 'Bollywood Hindi Arijit Singh Neha Kakkar AR Rahman',
                'thai': 'Thai T-Pop ไทย ลูกทุ่ง สากล',
                'vietnamese': 'Vietnamese V-Pop Sơn Tùng M-TP Hoàng Thùy Linh',
                'indonesian': 'Indonesian I-Pop Noah Dewa 19 Raisa',
                'philippines': 'OPM Filipino Ben&Ben Moira Dela Torre',
                'electronic': 'electronic EDM house techno dance',
                'rock': 'rock alternative indie guitar',
                'classical': 'classical piano violin orchestra',
                'lofi': 'lofi chillhop relax study beats',
                'jazz': 'jazz blues swing saxophone',
                'folk': 'folk acoustic indie singer songwriter',
                'metal': 'metal heavy rock hardcore',
                'ambient': 'ambient drone atmospheric sleep',
                'reggae': 'reggae dub dancehall',
                'latin': 'latin reggaeton salsa bachata',
                'african': 'afrobeat afropop amapiano highlife',
                'middleeastern': 'arabic turkish persian middle eastern',
                'turkish': 'turkish pop rock turkce muzik',
                'russian': 'russian pop rock shanson',
                'brazilian': 'brazilian bossa nova samba funk MPB'
            };
            
            searchAll(queries[type] || type);
        }

        async function searchAll(query) {
            showLoading();
            state.failedTracks.clear();
            
            try {
                const results = await Promise.allSettled([
                    searchAudius(query),
                    searchJamendo(query),
                    searchArchive(query),
                    searchRadioBrowser(query),
                    searchccMixter(query),
                    searchOpenverse(query),
                    searchMixkit(query),
                    searchPixabay(query)
                ]);

                let allTracks = [];
                results.forEach(r => {
                    if (r.status === 'fulfilled' && r.value) allTracks.push(...r.value);
                });

                allTracks = allTracks.filter(t => validateTrack(t));
                
                const seen = new Set();
                allTracks = allTracks.filter(t => {
                    if (seen.has(t.id)) return false;
                    seen.add(t.id);
                    return true;
                });

                allTracks.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                state.searchResults = allTracks;
                displayTracks(allTracks);
            } catch (e) {
                console.error('Search error:', e);
                showToast('Search failed');
            }
        }

        function validateTrack(t) {
            if (!t || !t.url) return false;
            if (state.failedTracks.has(t.id)) return false;
            if (t.duration && t.duration < 20) return false;
            if (!t.url.startsWith('http')) return false;
            return true;
        }

        async function searchAudius(query) {
            try {
                const res = await fetch(`https://discoveryprovider.audius.co/v1/tracks/search?query=${encodeURIComponent(query)}&app_name=Music&limit=60`);
                const data = await res.json();
                return data.data.map(t => ({
                    id: `audius-${t.id}`,
                    title: t.title || 'Unknown',
                    artist: t.user?.name || 'Unknown',
                    artwork: t.artwork?.['480x480'] || null,
                    duration: t.duration || 0,
                    popularity: t.play_count || 0,
                    url: `https://discoveryprovider.audius.co/v1/tracks/${t.id}/stream?app_name=Music`
                }));
            } catch (e) { return []; }
        }

        async function searchJamendo(query) {
            try {
                const res = await fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=8b0e4b6f&format=json&search=${encodeURIComponent(query)}&limit=60&order=popularity_total`);
                const data = await res.json();
                return data.results.map(t => ({
                    id: `jamendo-${t.id}`,
                    title: t.name || 'Unknown',
                    artist: t.artist_name || 'Unknown',
                    artwork: t.album_image || null,
                    duration: t.duration || 0,
                    popularity: t.stats?.rate_download_total || 0,
                    url: t.audio
                }));
            } catch (e) { return []; }
        }

        async function searchArchive(query) {
            try {
                const res = await fetch(`https://archive.org/advancedsearch.php?q=title:(${encodeURIComponent(query)})+AND+mediatype:audio+AND+(format:mp3+OR+format:flac)&fl[]=identifier,title,creator,downloads,item_size&sort[]=downloads+desc&rows=50&output=json`);
                const data = await res.json();
                
                const tracks = await Promise.all(data.response.docs.map(async (item) => {
                    try {
                        const url = await getArchiveUrl(item.identifier);
                        if (!url) return null;
                        return {
                            id: `archive-${item.identifier}`,
                            title: item.title?.substring(0, 100) || 'Unknown',
                            artist: item.creator || 'Archive',
                            artwork: `https://archive.org/services/img/${item.identifier}`,
                            duration: item.item_size ? Math.floor(item.item_size / 16000) : 180,
                            popularity: parseInt(item.downloads) || 0,
                            url: url
                        };
                    } catch (e) { return null; }
                }));
                return tracks.filter(Boolean);
            } catch (e) { return []; }
        }

        async function getArchiveUrl(identifier) {
            try {
                const res = await fetch(`https://archive.org/metadata/${identifier}`);
                const data = await res.json();
                const files = data.files?.filter(f => {
                    const ext = f.name.split('.').pop().toLowerCase();
                    return ['mp3', 'flac', 'ogg'].includes(ext) && (f.size > 300000);
                }).sort((a, b) => (b.size || 0) - (a.size || 0));
                if (files?.[0]) return `https://archive.org/download/${identifier}/${files[0].name}`;
                return null;
            } catch (e) { return null; }
        }

        async function searchRadioBrowser(query) {
            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${encodeURIComponent(query)}&limit=50&order=clickcount&reverse=true`);
                const data = await res.json();
                return data.map(s => ({
                    id: `radio-${s.stationuuid}`,
                    title: s.name || 'Radio',
                    artist: s.country || 'Radio',
                    artwork: s.favicon,
                    duration: 0,
                    popularity: s.clickcount || 0,
                    url: s.url_resolved || s.url
                })).filter(s => s.url?.startsWith('http'));
            } catch (e) { return []; }
        }

        async function searchccMixter(query) {
            try {
                const res = await fetch(`https://ccmixter.org/api/query?tags=${encodeURIComponent(query)}&limit=50&format=json`);
                const data = await res.json();
                return data.map(t => ({
                    id: `ccmixter-${t.upload_id}`,
                    title: t.upload_name || 'Unknown',
                    artist: t.user_real_name || t.user_name || 'Unknown',
                    artwork: t.upload_coverart,
                    duration: t.upload_extra?.duration || 180,
                    popularity: t.upload_score || 0,
                    url: t.files?.[0]?.download_url || t.download_url
                })).filter(t => t.url);
            } catch (e) { return []; }
        }

        async function searchOpenverse(query) {
            try {
                const res = await fetch(`https://api.openverse.org/v1/audio/?q=${encodeURIComponent(query)}&page_size=50`);
                const data = await res.json();
                return data.results.map(t => ({
                    id: `openverse-${t.id}`,
                    title: t.title || 'Unknown',
                    artist: t.creator || 'Unknown',
                    artwork: t.thumbnail,
                    duration: t.duration || 0,
                    popularity: t.rank || 0,
                    url: t.url
                })).filter(t => t.url);
            } catch (e) { return []; }
        }

        async function searchMixkit(query) {
            const library = [
                { title: 'Inspiring Cinematic', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-inspiring-cinematic-1.mp3', duration: 180, popularity: 1000 },
                { title: 'Tech House Vibes', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-1.mp3', duration: 180, popularity: 950 },
                { title: 'Relaxing Guitar', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-relaxing-guitar-1.mp3', duration: 180, popularity: 900 },
                { title: 'Summer Beach', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-summer-beach-1.mp3', duration: 180, popularity: 850 },
                { title: 'Deep Urban', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-deep-urban-1.mp3', duration: 180, popularity: 800 },
                { title: 'Ambient Piano', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-ambient-piano-1.mp3', duration: 180, popularity: 750 },
                { title: 'Hip Hop Loop', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-hip-hop-loop-1.mp3', duration: 180, popularity: 700 },
                { title: 'Cinematic Epic', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-cinematic-epic-1.mp3', duration: 180, popularity: 650 },
                { title: 'Lo-Fi Chill', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-lo-fi-chill-1.mp3', duration: 180, popularity: 600 },
                { title: 'Acoustic Folk', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-acoustic-folk-1.mp3', duration: 180, popularity: 550 },
                { title: 'Electronic Dance', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-electronic-dance-1.mp3', duration: 180, popularity: 500 },
                { title: 'Jazz Piano', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-jazz-piano-1.mp3', duration: 180, popularity: 450 },
                { title: 'Classical Orchestra', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-classical-orchestra-1.mp3', duration: 180, popularity: 400 },
                { title: 'Rock Energy', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-rock-energy-1.mp3', duration: 180, popularity: 350 },
                { title: 'Meditation Zen', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-meditation-zen-1.mp3', duration: 180, popularity: 300 }
            ];
            
            if (query === 'popular music') return library.map((t, i) => ({...t, id: `mixkit-${i}`, artwork: null}));
            return library.filter(t => t.title.toLowerCase().includes(query.toLowerCase()) || t.artist.toLowerCase().includes(query.toLowerCase())).map((t, i) => ({...t, id: `mixkit-${i}`, artwork: null}));
        }

        async function searchPixabay(query) {
            const library = [
                { title: 'Ambient Piano', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', duration: 120, popularity: 500 },
                { title: 'Electronic Future', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/03/09/audio_c8c8a73467.mp3', duration: 180, popularity: 450 },
                { title: 'Tropical House', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3', duration: 180, popularity: 400 },
                { title: 'Lo-Fi Study', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/04/27/audio_67bcf729cf.mp3', duration: 180, popularity: 350 },
                { title: 'Acoustic Guitar', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3', duration: 120, popularity: 300 },
                { title: 'Upbeat Pop', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/02/07/audio_1b6f6c6c4e.mp3', duration: 180, popularity: 250 },
                { title: 'Cinematic Drama', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/01/26/audio_d0c6ff1e32.mp3', duration: 180, popularity: 200 }
            ];
            
            if (query === 'popular music') return library.map((t, i) => ({...t, id: `pixabay-${i}`, artwork: null}));
            return library.filter(t => t.title.toLowerCase().includes(query.toLowerCase())).map((t, i) => ({...t, id: `pixabay-${i}`, artwork: null}));
        }

        async function loadAllSources() {
            showLoading();
            await searchAll('popular music');
        }

        function showLoading() {
            document.getElementById('trackList').innerHTML = Array(8).fill(0).map(() => `<div class="skeleton" style="height:64px;margin-bottom:2px"></div>`).join('');
        }

        function displayTracks(tracks) {
            const container = document.getElementById('trackList');
            document.getElementById('resultCount').textContent = tracks.length;
            
            if (tracks.length === 0) {
                container.innerHTML = `<div class="empty-state"><i classpx) {
            .library-panel {
                margin-left: 400px;
                min-height: 100vh;
                padding: 32px;
            }
        }

        .cd-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        @media (min-width: 768px) {
            .cd-wrapper {
                width: 280px;
                height: 280px;
            }
        }

        @media (min-width: 1024px) {
            .cd-wrapper {
                width: 320px;
                height: 320px;
                margin-bottom: 40px;
            }
        }

        .cd {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #111 0deg, #1a1a1a 20deg,
                #111 40deg, #222 60deg,
                #111 80deg, #1a1a1a 100deg,
                #111 120deg, #222 140deg,
                #111 160deg, #1a1a1a 180deg,
                #111 200deg, #222 220deg,
                #111 240deg, #1a1a1a 260deg,
                #111 280deg, #222 300deg,
                #111 320deg, #1a1a1a 340deg,
                #111 360deg
            );
            box-shadow: 
                0 0 0 3px #050505,
                0 0 0 4px #222,
                0 20px 50px rgba(0,0,0,1),
                inset 0 0 60px rgba(0,0,0,0.9);
            position: relative;
            animation: spin 3s linear infinite;
            animation-play-state: paused;
        }

        .cd.playing {
            animation-play-state: running;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .cd::before {
            content: '';
            position: absolute;
            inset: 15%;
            border-radius: 50%;
            background: #080808;
            border: 2px solid #222;
        }

        .cd::after {
            content: '';
            position: absolute;
            inset: 44%;
            border-radius: 50%;
            background: #000;
            border: 2px solid #1a1a1a;
        }

        .album-art {
            position: absolute;
            inset: 16%;
            width: 68%;
            height: 68%;
            left: 16%;
            top: 16%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .controls-area {
            width: 100%;
            max-width: 340px;
        }

        .progress-box {
            width: 100%;
            height: 5px;
            background: #111;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            margin: 16px 0 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-box:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 22px;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .ctrl-btn.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .vol-section {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 0 4px;
        }

        .vol-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .vol-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .vol-btn.muted {
            color: #ff4444;
        }

        .vol-slider-container {
            flex: 1;
            height: 36px;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .vol-track {
            width: 100%;
            height: 4px;
            background: #111;
            border-radius: 2px;
            position: relative;
            pointer-events: none;
        }

        .vol-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 75%;
            pointer-events: none;
            position: relative;
            transition: width 0.05s linear, background-color 0.2s;
        }

        .vol-fill.muted {
            background: #333;
        }

        .vol-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .vol-slider-container:hover .vol-handle,
        .vol-handle.dragging {
            opacity: 1;
        }

        .vol-handle.muted {
            background: #666;
        }

        .vol-text {
            font-size: 11px;
            color: #444;
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .vol-text.muted {
            color: #ff4444;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 44px 14px 44px;
            border-radius: 12px;
            border: 1px solid #111;
            background: #050505;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #222;
            background: #080808;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
            font-size: 18px;
        }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            display: none;
        }

        .clear-btn.visible {
            display: block;
        }

        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 24px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #111;
            background: transparent;
            color: #444;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover, .filter-chip.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .section-title {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }

        .track-card:hover {
            background: #050505;
        }

        .track-card.active {
            background: #080808;
            border-left-color: #fff;
        }

        .track-card.playing {
            background: #0a0a0a;
        }

        .track-img {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #080808;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .track-title {
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .track-meta {
            font-size: 11px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #222;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s;
            font-size: 18px;
        }

        .track-card:hover .track-action {
            opacity: 1;
        }

        .track-action:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .queue-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #080808;
        }

        .songs-section {
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #1a1a1a;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .empty-state i {
            font-size: 40px;
            color: #111;
        }

        .skeleton {
            background: linear-gradient(90deg, #050505 25%, #080808 50%, #050505 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 10px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .error-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .now-playing-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            width: 16px;
            height: 16px;
        }

        .bar {
            width: 3px;
            background: #fff;
            border-radius: 1px;
            animation: equalizer 0.8s ease-in-out infinite;
        }

        .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .bar:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .bar:nth-child(3) { height: 8px; animation-delay: 0.3s; }

        @keyframes equalizer {
            0%, 100% { transform: scaleY(0.6); }
            50% { transform: scaleY(1); }
        }

        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(5,5,5,0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #111;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .mini-player.visible {
            transform: translateY(0);
        }

        .mini-cover {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
        }

        .mini-info {
            flex: 1;
            min-width: 0;
        }

        .mini-title {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-artist {
            font-size: 11px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            gap: 8px;
        }

        .mini-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .mini-play {
            background: #fff;
            color: #000;
        }

        @media (min-width: 1024px) {
            .mini-player {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast"><i class="ph ph-check"></i><span id="toastText">Notification</span></div>
    <div class="error-indicator" id="errorIndicator"><i class="ph ph-warning"></i><span>Error</span></div>

    <div class="mini-player" id="miniPlayer">
        <img class="mini-cover" id="miniCover" src="" alt="">
        <div class="mini-info">
            <div class="mini-title" id="miniTitle">Select a song</div>
            <div class="mini-artist" id="miniArtist">Choose from library</div>
        </div>
        <div class="mini-controls">
            <button class="mini-btn" onclick="prevTrack()"><i class="ph ph-skip-back"></i></button>
            <button class="mini-btn mini-play" onclick="togglePlay()" id="miniPlayBtn"><i class="ph ph-play"></i></button>
            <button class="mini-btn" onclick="nextTrack()"><i class="ph ph-skip-forward"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <div class="player-panel">
            <div class="cd-wrapper">
                <div class="cd" id="cd">
                    <img id="coverArt" class="album-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23050505'/%3E%3Ccircle cx='100' cy='100' r='40' fill='%23080808'/%3E%3C/svg%3E" alt="">
                </div>
            </div>

            <div style="text-align: center; width: 100%; margin-bottom: 24px;">
                <h1 id="trackTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 6px; padding: 0 10px;">Select a song</h1>
                <p id="trackArtist" style="font-size: 13px; color: #333; margin-bottom: 8px;">Choose from library</p>
                <span id="sourceBadge" style="font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 0.1em;">Ready</span>
            </div>

            <div class="controls-area">
                <div class="progress-box" id="progressBox">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="btn-row">
                    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
                        <i class="ph ph-shuffle"></i>
                    </button>
                    <button class="ctrl-btn" onclick="prevTrack()" title="Previous">
                        <i class="ph ph-skip-back"></i>
                    </button>
                    <button class="play-btn" onclick="togglePlay()" id="playBtn">
                        <i class="ph ph-play" id="playIcon"></i>
                    </button>
                    <button class="ctrl-btn" onclick="nextTrack()" title="Next">
                        <i class="ph ph-skip-forward"></i>
                    </button>
                    <button class="ctrl-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">
                        <i class="ph ph-repeat"></i>
                    </button>
                </div>

                <div class="vol-section">
                    <button class="vol-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                        <i class="ph ph-speaker-high" id="volIcon"></i>
                    </button>
                    <div class="vol-slider-container" id="volSliderContainer">
                        <div class="vol-track">
                            <div class="vol-fill" id="volFill">
                                <div class="vol-handle" id="volHandle"></div>
                            </div>
                        </div>
                    </div>
                    <span class="vol-text" id="volText">75%</span>
                </div>
            </div>
        </div>

        <div class="library-panel">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists..." oninput="onSearch(this.value)">
                <button class="clear-btn" id="clearBtn" onclick="clearSearch()"><i class="ph ph-x"></i></button>
            </div>

            <div class="filter-scroll">
                <button class="filter-chip active" onclick="setFilter('all', this)"><i class="ph ph-fire"></i> All</button>
                <button class="filter-chip" onclick="setFilter('mandopop', this)"><i class="ph ph-music-notes"></i> 华语</button>
                <button class="filter-chip" onclick="setFilter('cantopop', this)"><i class="ph ph-vinyl-record"></i> 粤语</button>
                <button class="filter-chip" onclick="setFilter('kpop', this)"><i class="ph ph-star"></i> K-Pop</button>
                <button class="filter-chip" onclick="setFilter('jpop', this)"><i class="ph ph-piano-keys"></i> J-Pop</button>
                <button class="filter-chip" onclick="setFilter('anime', this)"><i class="ph ph-television"></i> Anime</button>
                <button class="filter-chip" onclick="setFilter('bollywood', this)"><i class="ph ph-film-strip"></i> Bollywood</button>
                <button class="filter-chip" onclick="setFilter('thai', this)"><i class="ph ph-temple"></i> Thai</button>
                <button class="filter-chip" onclick="setFilter('vietnamese', this)"><i class="ph ph-coffee"></i> V-Pop</button>
                <button class="filter-chip" onclick="setFilter('indonesian', this)"><i class="ph ph-island"></i> Indo</button>
                <button class="filter-chip" onclick="setFilter('philippines', this)"><i class="ph ph-sun"></i> OPM</button>
                <button class="filter-chip" onclick="setFilter('electronic', this)"><i class="ph ph-speaker-hifi"></i> Electronic</button>
                <button class="filter-chip" onclick="setFilter('rock', this)"><i class="ph ph-guitar"></i> Rock</button>
                <button class="filter-chip" onclick="setFilter('classical', this)"><i class="ph ph-violin"></i> Classical</button>
                <button class="filter-chip" onclick="setFilter('lofi', this)"><i class="ph ph-coffee"></i> Lo-Fi</button>
                <button class="filter-chip" onclick="setFilter('jazz', this)"><i class="ph ph-saxophone"></i> Jazz</button>
                <button class="filter-chip" onclick="setFilter('folk', this)"><i class="ph ph-tree-palm"></i> Folk</button>
                <button class="filter-chip" onclick="setFilter('metal', this)"><i class="ph ph-lightning"></i> Metal</button>
                <button class="filter-chip" onclick="setFilter('ambient', this)"><i class="ph ph-cloud"></i> Ambient</button>
                <button class="filter-chip" onclick="setFilter('reggae', this)"><i class="ph ph-sun-horizon"></i> Reggae</button>
                <button class="filter-chip" onclick="setFilter('latin', this)"><i class="ph ph-music-note"></i> Latin</button>
                <button class="filter-chip" onclick="setFilter('african', this)"><i class="ph ph-drums"></i> Afro</button>
                <button class="filter-chip" onclick="setFilter('middleeastern', this)"><i class="ph ph-moon"></i> Arabic</button>
                <button class="filter-chip" onclick="setFilter('turkish', this)"><i class="ph ph-mosque"></i> Turkish</button>
                <button class="filter-chip" onclick="setFilter('russian', this)"><i class="ph ph-snowflake"></i> Russian</button>
                <button class="filter-chip" onclick="setFilter('brazilian', this)"><i class="ph ph-soccer-ball"></i> Brazilian</button>
            </div>

            <div class="queue-section">
                <div class="section-title">
                    <span><i class="ph ph-queue" style="margin-right:6px"></i>Queue</span>
                    <span id="queueCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="queueList">
                    <div class="empty-state">
                        <i class="ph ph-queue"></i>
                        <div>Queue empty</div>
                    </div>
                </div>
            </div>

            <div class="songs-section">
                <div class="section-title">
                    <span><i class="ph ph-music-notes" style="margin-right:6px"></i>Songs</span>
                    <span id="resultCount" style="color:#1a1a1a">0</span>
                </div>
                <div class="track-list" id="trackList">
                    <div class="empty-state">
                        <i class="ph ph-spinner animate-spin"></i>
                        <div>Loading...</div>
                    </div>
                </div>
            </div>

            <div style="height:100px"></div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous" preload="metadata" style="display:none"></audio>

    <script>
        const state = {
            currentTrack: null,
            isPlaying: false,
            queue: [],
            currentIndex: -1,
            isShuffle: false,
            isRepeat: false,
            volume: 75,
            lastVolume: 75,
            isMuted: false,
            searchResults: [],
            failedTracks: new Set()
        };

        const audio = document.getElementById('audioPlayer');
        const cd = document.getElementById('cd');

        window.onload = () => {
            audio.volume = 0.75;
            setupAudioEvents();
            setupVolumeControl();
            loadAllSources();
        };

        function setupAudioEvents() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', handleEnded);
            audio.addEventListener('error', handleError);
            audio.addEventListener('canplay', () => hideError());
            audio.addEventListener('loadedmetadata', () => {
                document.getElementById('totalTime').textContent = formatTime(audio.duration);
            });
            document.getElementById('progressBox').addEventListener('click', seek);
        }

        function updateProgress() {
            if (audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFill').style.width = pct + '%';
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            }
        }

        function seek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if (audio.duration) audio.currentTime = pct * audio.duration;
        }

        function handleEnded() {
            if (state.isRepeat) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } else {
                nextTrack();
            }
        }

        function handleError(e) {
            console.error('Audio error:', e);
            if (state.currentTrack) {
                state.failedTracks.add(state.currentTrack.id);
                showError('Track unavailable');
                setTimeout(() => nextTrack(), 1500);
            }
        }

        function setupVolumeControl() {
            const container = document.getElementById('volSliderContainer');
            const fill = document.getElementById('volFill');
            const handle = document.getElementById('volHandle');
            const text = document.getElementById('volText');
            const btn = document.getElementById('muteBtn');
            const icon = document.getElementById('volIcon');

            let isDragging = false;

            function updateVolume(clientX) {
                const rect = container.getBoundingClientRect();
                let pct = (clientX - rect.left) / rect.width;
                pct = Math.max(0, Math.min(1, pct));
                const vol = Math.round(pct * 100);
                
                if (vol === 0) {
                    state.isMuted = true;
                    audio.volume = 0;
                } else {
                    state.isMuted = false;
                    audio.volume = vol / 100;
                    state.volume = vol;
                }
                updateVolUI();
            }

            function updateVolUI() {
                const displayVol = state.isMuted ? 0 : state.volume;
                fill.style.width = displayVol + '%';
                text.textContent = displayVol + '%';
                
                if (state.isMuted || state.volume === 0) {
                    icon.className = 'ph ph-speaker-x';
                    btn.classList.add('muted');
                    fill.classList.add('muted');
                    handle.classList.add('muted');
                    text.classList.add('muted');
                } else if (state.volume < 30) {
                    icon.className = 'ph ph-speaker-low';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                } else if (state.volume < 70) {
                    icon.className = 'ph ph-speaker-medium';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                } else {
                    icon.className = 'ph ph-speaker-high';
                    btn.classList.remove('muted');
                    fill.classList.remove('muted');
                    handle.classList.remove('muted');
                    text.classList.remove('muted');
                }
            }

            container.addEventListener('click', (e) => {
                if (!isDragging) updateVolume(e.clientX);
            });

            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                handle.classList.add('dragging');
                updateVolume(e.clientX);
                
                const moveHandler = (e) => {
                    if (isDragging) updateVolume(e.clientX);
                };
                
                const upHandler = () => {
                    isDragging = false;
                    handle.classList.remove('dragging');
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            });

            container.addEventListener('touchstart', (e) => {
                isDragging = true;
                handle.classList.add('dragging');
                updateVolume(e.touches[0].clientX);
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    updateVolume(e.touches[0].clientX);
                }
            }, { passive: false });

            container.addEventListener('touchend', () => {
                isDragging = false;
                handle.classList.remove('dragging');
            });

            state.updateVolUI = updateVolUI;
            updateVolUI();
        }

        function toggleMute() {
            if (state.isMuted) {
                const restore = state.lastVolume > 0 ? state.lastVolume : 75;
                state.isMuted = false;
                state.volume = restore;
                audio.volume = restore / 100;
            } else {
                state.lastVolume = state.volume;
                state.isMuted = true;
                audio.volume = 0;
            }
            if (state.updateVolUI) state.updateVolUI();
        }

        let searchTimer;
        function onSearch(val) {
            document.getElementById('clearBtn').classList.toggle('visible', val.length > 0);
            clearTimeout(searchTimer);
            if (val.length < 2) {
                if (val.length === 0) loadAllSources();
                return;
            }
            searchTimer = setTimeout(() => searchAll(val), 300);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').classList.remove('visible');
            loadAllSources();
        }

        function setFilter(type, btn) {
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const queries = {
                'all': 'popular music',
                'mandopop': '华语流行 周杰伦 薛之谦 邓紫棋 林俊杰 李荣浩 毛不易 周深',
                'cantopop': '粤语 陈奕迅 Beyond 王菲 张学友 李克勤 邓紫棋 杨千嬅',
                'kpop': 'K-Pop BTS BLACKPINK TWICE IVE NewJeans SEVENTEEN',
                'jpop': 'J-Pop YOASOBI Official髭男dism Ado LiSA Aimer RADWIMPS',
                'anime': 'anime opening ending OST 鬼滅の刃 進撃の巨人 ワンピース',
                'bollywood': 'Bollywood Hindi Arijit Singh Neha Kakkar AR Rahman',
                'thai': 'Thai T-Pop ไทย ลูกทุ่ง สากล',
                'vietnamese': 'Vietnamese V-Pop Sơn Tùng M-TP Hoàng Thùy Linh',
                'indonesian': 'Indonesian I-Pop Noah Dewa 19 Raisa',
                'philippines': 'OPM Filipino Ben&Ben Moira Dela Torre',
                'electronic': 'electronic EDM house techno dance',
                'rock': 'rock alternative indie guitar',
                'classical': 'classical piano violin orchestra',
                'lofi': 'lofi chillhop relax study beats',
                'jazz': 'jazz blues swing saxophone',
                'folk': 'folk acoustic indie singer songwriter',
                'metal': 'metal heavy rock hardcore',
                'ambient': 'ambient drone atmospheric sleep',
                'reggae': 'reggae dub dancehall',
                'latin': 'latin reggaeton salsa bachata',
                'african': 'afrobeat afropop amapiano highlife',
                'middleeastern': 'arabic turkish persian middle eastern',
                'turkish': 'turkish pop rock turkce muzik',
                'russian': 'russian pop rock shanson',
                'brazilian': 'brazilian bossa nova samba funk MPB'
            };
            
            searchAll(queries[type] || type);
        }

        async function searchAll(query) {
            showLoading();
            state.failedTracks.clear();
            
            try {
                const results = await Promise.allSettled([
                    searchAudius(query),
                    searchJamendo(query),
                    searchArchive(query),
                    searchRadioBrowser(query),
                    searchccMixter(query),
                    searchOpenverse(query),
                    searchMixkit(query),
                    searchPixabay(query)
                ]);

                let allTracks = [];
                results.forEach(r => {
                    if (r.status === 'fulfilled' && r.value) allTracks.push(...r.value);
                });

                allTracks = allTracks.filter(t => validateTrack(t));
                
                const seen = new Set();
                allTracks = allTracks.filter(t => {
                    if (seen.has(t.id)) return false;
                    seen.add(t.id);
                    return true;
                });

                allTracks.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                state.searchResults = allTracks;
                displayTracks(allTracks);
            } catch (e) {
                console.error('Search error:', e);
                showToast('Search failed');
            }
        }

        function validateTrack(t) {
            if (!t || !t.url) return false;
            if (state.failedTracks.has(t.id)) return false;
            if (t.duration && t.duration < 20) return false;
            if (!t.url.startsWith('http')) return false;
            return true;
        }

        async function searchAudius(query) {
            try {
                const res = await fetch(`https://discoveryprovider.audius.co/v1/tracks/search?query=${encodeURIComponent(query)}&app_name=Music&limit=60`);
                const data = await res.json();
                return data.data.map(t => ({
                    id: `audius-${t.id}`,
                    title: t.title || 'Unknown',
                    artist: t.user?.name || 'Unknown',
                    artwork: t.artwork?.['480x480'] || null,
                    duration: t.duration || 0,
                    popularity: t.play_count || 0,
                    url: `https://discoveryprovider.audius.co/v1/tracks/${t.id}/stream?app_name=Music`
                }));
            } catch (e) { return []; }
        }

        async function searchJamendo(query) {
            try {
                const res = await fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=8b0e4b6f&format=json&search=${encodeURIComponent(query)}&limit=60&order=popularity_total`);
                const data = await res.json();
                return data.results.map(t => ({
                    id: `jamendo-${t.id}`,
                    title: t.name || 'Unknown',
                    artist: t.artist_name || 'Unknown',
                    artwork: t.album_image || null,
                    duration: t.duration || 0,
                    popularity: t.stats?.rate_download_total || 0,
                    url: t.audio
                }));
            } catch (e) { return []; }
        }

        async function searchArchive(query) {
            try {
                const res = await fetch(`https://archive.org/advancedsearch.php?q=title:(${encodeURIComponent(query)})+AND+mediatype:audio+AND+(format:mp3+OR+format:flac)&fl[]=identifier,title,creator,downloads,item_size&sort[]=downloads+desc&rows=50&output=json`);
                const data = await res.json();
                
                const tracks = await Promise.all(data.response.docs.map(async (item) => {
                    try {
                        const url = await getArchiveUrl(item.identifier);
                        if (!url) return null;
                        return {
                            id: `archive-${item.identifier}`,
                            title: item.title?.substring(0, 100) || 'Unknown',
                            artist: item.creator || 'Archive',
                            artwork: `https://archive.org/services/img/${item.identifier}`,
                            duration: item.item_size ? Math.floor(item.item_size / 16000) : 180,
                            popularity: parseInt(item.downloads) || 0,
                            url: url
                        };
                    } catch (e) { return null; }
                }));
                return tracks.filter(Boolean);
            } catch (e) { return []; }
        }

        async function getArchiveUrl(identifier) {
            try {
                const res = await fetch(`https://archive.org/metadata/${identifier}`);
                const data = await res.json();
                const files = data.files?.filter(f => {
                    const ext = f.name.split('.').pop().toLowerCase();
                    return ['mp3', 'flac', 'ogg'].includes(ext) && (f.size > 300000);
                }).sort((a, b) => (b.size || 0) - (a.size || 0));
                if (files?.[0]) return `https://archive.org/download/${identifier}/${files[0].name}`;
                return null;
            } catch (e) { return null; }
        }

        async function searchRadioBrowser(query) {
            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${encodeURIComponent(query)}&limit=50&order=clickcount&reverse=true`);
                const data = await res.json();
                return data.map(s => ({
                    id: `radio-${s.stationuuid}`,
                    title: s.name || 'Radio',
                    artist: s.country || 'Radio',
                    artwork: s.favicon,
                    duration: 0,
                    popularity: s.clickcount || 0,
                    url: s.url_resolved || s.url
                })).filter(s => s.url?.startsWith('http'));
            } catch (e) { return []; }
        }

        async function searchccMixter(query) {
            try {
                const res = await fetch(`https://ccmixter.org/api/query?tags=${encodeURIComponent(query)}&limit=50&format=json`);
                const data = await res.json();
                return data.map(t => ({
                    id: `ccmixter-${t.upload_id}`,
                    title: t.upload_name || 'Unknown',
                    artist: t.user_real_name || t.user_name || 'Unknown',
                    artwork: t.upload_coverart,
                    duration: t.upload_extra?.duration || 180,
                    popularity: t.upload_score || 0,
                    url: t.files?.[0]?.download_url || t.download_url
                })).filter(t => t.url);
            } catch (e) { return []; }
        }

        async function searchOpenverse(query) {
            try {
                const res = await fetch(`https://api.openverse.org/v1/audio/?q=${encodeURIComponent(query)}&page_size=50`);
                const data = await res.json();
                return data.results.map(t => ({
                    id: `openverse-${t.id}`,
                    title: t.title || 'Unknown',
                    artist: t.creator || 'Unknown',
                    artwork: t.thumbnail,
                    duration: t.duration || 0,
                    popularity: t.rank || 0,
                    url: t.url
                })).filter(t => t.url);
            } catch (e) { return []; }
        }

        async function searchMixkit(query) {
            const library = [
                { title: 'Inspiring Cinematic', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-inspiring-cinematic-1.mp3', duration: 180, popularity: 1000 },
                { title: 'Tech House Vibes', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-1.mp3', duration: 180, popularity: 950 },
                { title: 'Relaxing Guitar', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-relaxing-guitar-1.mp3', duration: 180, popularity: 900 },
                { title: 'Summer Beach', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-summer-beach-1.mp3', duration: 180, popularity: 850 },
                { title: 'Deep Urban', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-deep-urban-1.mp3', duration: 180, popularity: 800 },
                { title: 'Ambient Piano', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-ambient-piano-1.mp3', duration: 180, popularity: 750 },
                { title: 'Hip Hop Loop', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-hip-hop-loop-1.mp3', duration: 180, popularity: 700 },
                { title: 'Cinematic Epic', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-cinematic-epic-1.mp3', duration: 180, popularity: 650 },
                { title: 'Lo-Fi Chill', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-lo-fi-chill-1.mp3', duration: 180, popularity: 600 },
                { title: 'Acoustic Folk', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-acoustic-folk-1.mp3', duration: 180, popularity: 550 },
                { title: 'Electronic Dance', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-electronic-dance-1.mp3', duration: 180, popularity: 500 },
                { title: 'Jazz Piano', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-jazz-piano-1.mp3', duration: 180, popularity: 450 },
                { title: 'Classical Orchestra', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-classical-orchestra-1.mp3', duration: 180, popularity: 400 },
                { title: 'Rock Energy', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-rock-energy-1.mp3', duration: 180, popularity: 350 },
                { title: 'Meditation Zen', artist: 'Mixkit', url: 'https://assets.mixkit.co/music/preview/mixkit-meditation-zen-1.mp3', duration: 180, popularity: 300 }
            ];
            
            if (query === 'popular music') return library.map((t, i) => ({...t, id: `mixkit-${i}`, artwork: null}));
            return library.filter(t => t.title.toLowerCase().includes(query.toLowerCase()) || t.artist.toLowerCase().includes(query.toLowerCase())).map((t, i) => ({...t, id: `mixkit-${i}`, artwork: null}));
        }

        async function searchPixabay(query) {
            const library = [
                { title: 'Ambient Piano', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', duration: 120, popularity: 500 },
                { title: 'Electronic Future', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/03/09/audio_c8c8a73467.mp3', duration: 180, popularity: 450 },
                { title: 'Tropical House', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3', duration: 180, popularity: 400 },
                { title: 'Lo-Fi Study', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/04/27/audio_67bcf729cf.mp3', duration: 180, popularity: 350 },
                { title: 'Acoustic Guitar', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3', duration: 120, popularity: 300 },
                { title: 'Upbeat Pop', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/02/07/audio_1b6f6c6c4e.mp3', duration: 180, popularity: 250 },
                { title: 'Cinematic Drama', artist: 'Pixabay', url: 'https://cdn.pixabay.com/download/audio/2022/01/26/audio_d0c6ff1e32.mp3', duration: 180, popularity: 200 }
            ];
            
            if (query === 'popular music') return library.map((t, i) => ({...t, id: `pixabay-${i}`, artwork: null}));
            return library.filter(t => t.title.toLowerCase().includes(query.toLowerCase())).map((t, i) => ({...t, id: `pixabay-${i}`, artwork: null}));
        }

        async function loadAllSources() {
            showLoading();
            await searchAll('popular music');
        }

        function showLoading() {
            document.getElementById('trackList').innerHTML = Array(8).fill(0).map(() => `<div class="skeleton" style="height:64px;margin-bottom:2px"></div>`).join('');
        }

        function displayTracks(tracks) {
            const container = document.getElementById('trackList');
            document.getElementById('resultCount').textContent = tracks.length;
            
            if (tracks.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="ph ph-music-note"></i><div>No songs found</div></div>`;
                return;
            }
            
            container.innerHTML = tracks.map((t, i) => `
                <div class="track-card ${state.currentTrack?.id === t.id ? 'active' : ''} ${state.isPlaying && state.currentTrack?.id === t.id ? 'playing' : ''}" onclick="playTrack(${i})" data-idx="${i}">
                    <img class="track-img" src="${t.artwork || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 44 44%22%3E%3Crect width=%2244%22 height=%2244%22 fill=%22%23080808%22/%3E%3C/svg%3E'}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 44 44%22%3E%3Crect width=%2244%22 height=%2244%22 fill=%22%23080808%22/%3E%3C/svg%3E'" loading="lazy">
                    <div class="track-info">
                        <div class="track-title-row"><span class="track-title">${escapeHtml(t.title)}</span></div>
                        <div class="track-meta">${escapeHtml(t.artist)} • ${formatTime(t.duration)}</div>
                    </div>
                    <button class="track-action" onclick="event.stopPropagation();queueTrack(${i})" title="Add to queue"><i class="ph ph-plus"></i></button>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function playTrack(index) {
            const track = state.searchResults[index];
            if (!track) return;
            
            if (state.failedTracks.has(track.id)) {
                showToast('Unavailable, skipping...');
                playNextValid(index);
                return;
            }
            
            const existing = state.queue.findIndex(t => t.id === track.id);
            if (existing === -1) {
                state.queue.push(track);
                state.currentIndex = state.queue.length - 1;
            } else {
                state.currentIndex = existing;
            }
            
            await loadAndPlay(track);
            updateQueue();
        }

        async function loadAndPlay(track) {
            try {
                state.currentTrack = track;
                document.getElementById('trackTitle').textContent = track.title;
                document.getElementById('trackArtist').textContent = track.artist;
                document.getElementById('coverArt').src = track.artwork || '';
                document.getElementById('sourceBadge').textContent = track.artist !== 'Unknown' ? 'Now Playing' : 'Radio';
                
                document.getElementById('miniTitle').textContent = track.title;
                document.getElementById('miniArtist').textContent = track.artist;
                document.getElementById('miniCover').src = track.artwork || '';
                document.getElementById('miniPlayer').classList.add('visible');
                
                audio.src = track.url;
                audio.load();
                
                await new Promise((resolve, reject) => {
                    const onCanPlay = () => {
                        audio.removeEventListener('canplay', onCanPlay);
                        audio.removeEventListener('error', onError);
                        resolve();
                    };
                    const onError = (e) => {
                        audio.removeEventListener('canplay', onCanPlay);
                        audio.removeEventListener('error', onError);
                        reject(e);
                    };
                    audio.addEventListener('canplay', onCanPlay);
                    audio.addEventListener('error', onError);
                    setTimeout(() => reject(new Error('Timeout')), 15000);
                });
                
                await audio.play();
                state.isPlaying = true;
                updatePlayState();
                
                document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active', 'playing'));
                const active = document.querySelector(`[data-idx="${state.searchResults.findIndex(t => t.id === track.id)}"]`);
                if (active) active.classList.add('active', 'playing');
                
                hideError();
            } catch (e) {
                state.failedTracks.add(track.id);
                showError('Failed to load');
                playNextValid(state.searchResults.findIndex(t => t.id === track.id));
            }
        }

        function playNextValid(currentIndex) {
            for (let i = 1; i < state.searchResults.length; i++) {
                const nextIdx = (currentIndex + i) % state.searchResults.length;
                const nextTrack = state.searchResults[nextIdx];
                if (!state.failedTracks.has(nextTrack.id)) {
                    playTrack(nextIdx);
                    return;
                }
            }
            showToast('No playable tracks');
        }

        function togglePlay() {
            if (!state.currentTrack) {
                if (state.searchResults.length > 0) playTrack(0);
                else loadAllSources();
                return;
            }
            
            if (state.isPlaying) {
                audio.pause();
                state.isPlaying = false;
            } else {
                audio.play().catch(() => nextTrack());
                state.isPlaying = true;
            }
            updatePlayState();
        }

        function updatePlayState() {
            const icon = document.getElementById('playIcon');
            const miniBtn = document.getElementById('miniPlayBtn');
            
            if (state.isPlaying) {
                icon.className = 'ph ph-pause';
                cd.classList.add('playing');
                if (miniBtn) miniBtn.innerHTML = '<i class="ph ph-pause"></i>';
            } else {
                icon.className = 'ph ph-play';
                cd.classList.remove('playing');
                if (miniBtn) miniBtn.innerHTML = '<i class="ph ph-play"></i>';
            }
            
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('playing'));
            if (state.isPlaying && state.currentTrack) {
                const active = document.querySelector(`[data-idx="${state.searchResults.findIndex(t => t.id === state.currentTrack.id)}"]`);
                if (active) active.classList.add('playing');
            }
            updateQueue();
        }

        function nextTrack() {
            if (state.queue.length === 0) return;
            
            let attempts = 0;
            let nextIdx;
            
            do {
                if (state.isShuffle) {
                    nextIdx = Math.floor(Math.random() * state.queue.length);
                } else {
                    nextIdx = (state.currentIndex + 1) % state.queue.length;
                }
                attempts++;
            } while (state.failedTracks.has(state.queue[nextIdx]?.id) && attempts < state.queue.length);
            
            if (attempts >= state.queue.length) {
                showToast('Queue empty');
                return;
            }
            
            state.currentIndex = nextIdx;
            loadAndPlay(state.queue[nextIdx]);
            updateQueue();
        }

        function prevTrack() {
            if (state.queue.length === 0) return;
            state.currentIndex = (state.currentIndex - 1 + state.queue.length) % state.queue.length;
            loadAndPlay(state.queue[state.currentIndex]);
            updateQueue();
        }

        function toggleShuffle() {
            state.isShuffle = !state.isShuffle;
            document.getElementById('shuffleBtn').classList.toggle('active', state.isShuffle);
            showToast(state.isShuffle ? 'Shuffle on' : 'Shuffle off');
        }

        function toggleRepeat() {
            state.isRepeat = !state.isRepeat;
            document.getElementById('repeatBtn').classList.toggle('active', state.isRepeat);
            showToast(state.isRepeat ? 'Repeat on' : 'Repeat off');
        }

        function queueTrack(index) {
            const track = state.searchResults[index];
            if (!track) return;
            
            if (state.queue.find(t => t.id === track.id)) {
                showToast('Already in queue');
                return;
            }
            
            state.queue.push(track);
            updateQueue();
            showToast('Added to queue');
        }

        function updateQueue() {
            const list = document.getElementById('queueList');
            document.getElementById('queueCount').textContent = state.queue.length;
            
            if (state.queue.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="ph ph-queue"></i><div>Queue empty</div></div>`;
                return;
            }
            
            list.innerHTML = state.queue.map((t, i) => `
                <div class="track-card ${i === state.currentIndex ? 'active' : ''}" onclick="playQueueIndex(${i})" style="padding:8px 12px">
                    <span style="width:20px;font-size:11px;color:#1a1a1a;font-weight:600">${i + 1}</span>
                    <div class="track-info">
                        <div class="track-title" style="font-size:12px;color:${i === state.currentIndex ? '#fff' : '#666'}">${escapeHtml(t.title)}</div>
                        <div class="track-meta" style="font-size:10px">${escapeHtml(t.artist)}</div>
                    </div>
                    ${i === state.currentIndex && state.isPlaying ? `<div class="now-playing-indicator"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>` : ''}
                </div>
            `).join('');
        }

        function playQueueIndex(index) {
            state.currentIndex = index;
            loadAndPlay(state.queue[index]);
            updateQueue();
        }

        function clearQueue() {
            state.queue = [];
            state.currentIndex = -1;
            updateQueue();
            showToast('Queue cleared');
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastText').textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function showError(msg) {
            const e = document.getElementById('errorIndicator');
            e.querySelector('span').textContent = msg;
            e.classList.add('show');
            setTimeout(() => e.classList.remove('show'), 3000);
        }

        function hideError() {
            document.getElementById('errorIndicator').classList.remove('show');
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    if (e.shiftKey) nextTrack();
                    else if (audio.duration) audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
                    break;
                case 'ArrowLeft':
                    if (e.shiftKey) prevTrack();
                    else audio.currentTime = Math.max(0, audio.currentTime - 5);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    changeVolume(5);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    changeVolume(-5);
                    break;
                case 'KeyM':
                    toggleMute();
                    break;
            }
        });

        function changeVolume(delta) {
            const newVol = Math.max(0, Math.min(100, (state.isMuted ? 0 : state.volume) + delta));
            if (newVol === 0) {
                state.isMuted = true;
                audio.volume = 0;
            } else {
                state.isMuted = false;
                state.volume = newVol;
                audio.volume = newVol / 100;
            }
            if (state.updateVolUI) state.updateVolUI();
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
