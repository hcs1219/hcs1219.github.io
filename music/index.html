<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        /* Range input reset */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }
        
        /* Hide desktop on mobile, hide mobile on desktop */
        .mobile-only { display: block; }
        .desktop-only { display: none; }
        
        @media (min-width: 1024px) {
            .mobile-only { display: none; }
            .desktop-only { display: block; }
        }
        
        /* CD Animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 8s linear infinite;
        }
        .paused {
            animation-play-state: paused;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    
    <!-- MOBILE LAYOUT -->
    <div class="mobile-only">
        <!-- Player View -->
        <div id="mobilePlayer" class="fixed inset-0 bg-black z-50 flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-900">
                <button onclick="showMobileLibrary()" class="p-2">
                    <i data-lucide="chevron-down" class="w-6 h-6"></i>
                </button>
                <span class="text-xs uppercase tracking-widest text-gray-500">Now Playing</span>
                <button onclick="toggleMobileQueue()" class="p-2">
                    <i data-lucide="list-music" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Album Art -->
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="relative w-64 h-64">
                    <div id="mobileCd" class="w-full h-full rounded-full bg-gradient-to-br from-gray-800 to-black border-4 border-gray-900 shadow-2xl flex items-center justify-center paused animate-spin-slow">
                        <img id="mobileCover" src="" alt="" class="w-3/4 h-3/4 rounded-full object-cover">
                        <div class="absolute inset-0 rounded-full border-2 border-gray-700 opacity-50"></div>
                    </div>
                </div>
            </div>
            
            <!-- Track Info -->
            <div class="px-6 pb-4 text-center">
                <h2 id="mobileTitle" class="text-xl font-bold mb-1 truncate">Select a song</h2>
                <p id="mobileArtist" class="text-gray-500 text-sm truncate">From library</p>
            </div>
            
            <!-- Progress -->
            <div class="px-6 py-4">
                <input type="range" id="mobileProgress" min="0" max="100" value="0" class="w-full mb-2" oninput="seek(this.value)">
                <div class="flex justify-between text-xs text-gray-600">
                    <span id="mobileCurrentTime">0:00</span>
                    <span id="mobileDuration">0:00</span>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center justify-center gap-6 pb-6">
                <button onclick="toggleShuffle()" id="mobileShuffle" class="p-2 text-gray-600">
                    <i data-lucide="shuffle" class="w-5 h-5"></i>
                </button>
                <button onclick="prevTrack()" class="p-2">
                    <i data-lucide="skip-back" class="w-8 h-8 fill-white"></i>
                </button>
                <button onclick="togglePlay()" id="mobilePlayBtn" class="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center">
                    <i data-lucide="play" class="w-8 h-8 fill-black ml-1"></i>
                </button>
                <button onclick="nextTrack()" class="p-2">
                    <i data-lucide="skip-forward" class="w-8 h-8 fill-white"></i>
                </button>
                <button onclick="toggleRepeat()" id="mobileRepeat" class="p-2 text-gray-600">
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Volume -->
            <div class="px-6 pb-8 flex items-center gap-3">
                <button onclick="toggleMute()" id="mobileMute">
                    <i data-lucide="volume-2" class="w-5 h-5 text-gray-500"></i>
                </button>
                <input type="range" id="mobileVolume" min="0" max="100" value="75" class="flex-1" oninput="setVolume(this.value)">
            </div>
        </div>
        
        <!-- Library View -->
        <div id="mobileLibrary" class="min-h-screen bg-black pb-24">
            <!-- Search -->
            <div class="sticky top-0 bg-black z-40 p-4 border-b border-gray-900">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-600"></i>
                    <input type="text" id="mobileSearch" placeholder="Search songs..." 
                           class="w-full bg-gray-900 rounded-full py-3 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-gray-700"
                           oninput="search(this.value)">
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex gap-2 overflow-x-auto p-4 scrollbar-hide">
                <button onclick="filter('all')" class="filter-btn px-4 py-2 bg-white text-black rounded-full text-xs font-medium whitespace-nowrap">All</button>
                <button onclick="filter('mandopop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">华语</button>
                <button onclick="filter('kpop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">K-Pop</button>
                <button onclick="filter('jpop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">J-Pop</button>
                <button onclick="filter('anime')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Anime</button>
                <button onclick="filter('electronic')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Electronic</button>
                <button onclick="filter('rock')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-xs font-medium whitespace-nowrap">Rock</button>
            </div>
            
            <!-- Songs List -->
            <div id="mobileSongs" class="px-4 space-y-1">
                <div class="text-center py-12 text-gray-600">
                    <div class="animate-spin w-8 h-8 border-2 border-gray-700 border-t-white rounded-full mx-auto mb-4"></div>
                    Loading...
                </div>
            </div>
        </div>
        
        <!-- Mini Player -->
        <div id="mobileMini" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-3 hidden" onclick="showMobilePlayer()">
            <div class="flex items-center gap-3">
                <img id="miniCover" src="" class="w-12 h-12 rounded bg-gray-800 object-cover">
                <div class="flex-1 min-w-0">
                    <div id="miniTitle" class="text-sm font-medium truncate">Select a song</div>
                    <div id="miniArtist" class="text-xs text-gray-500 truncate">Tap to play</div>
                </div>
                <button onclick="event.stopPropagation(); togglePlay()" class="p-2">
                    <i id="miniPlayIcon" data-lucide="play" class="w-6 h-6 fill-white"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Queue Modal -->
        <div id="mobileQueueModal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-900">
                <h3 class="font-bold">Queue</h3>
                <button onclick="toggleMobileQueue()" class="p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="mobileQueueList" class="flex-1 overflow-y-auto p-4 space-y-1">
                <div class="text-center text-gray-600 py-8">Queue empty</div>
            </div>
            <div class="p-4 border-t border-gray-900">
                <button onclick="clearQueue(); toggleMobileQueue()" class="w-full py-3 bg-gray-900 rounded-lg text-sm">Clear Queue</button>
            </div>
        </div>
    </div>
    
    <!-- DESKTOP LAYOUT -->
    <div class="desktop-only min-h-screen flex">
        <!-- Sidebar Player -->
        <div class="w-96 bg-black border-r border-gray-900 flex flex-col fixed h-full">
            <!-- Album Art -->
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="relative w-72 h-72">
                    <div id="desktopCd" class="w-full h-full rounded-full bg-gradient-to-br from-gray-800 to-black border-4 border-gray-900 shadow-2xl flex items-center justify-center paused animate-spin-slow">
                        <img id="desktopCover" src="" alt="" class="w-3/4 h-3/4 rounded-full object-cover">
                    </div>
                </div>
            </div>
            
            <!-- Info -->
            <div class="px-8 pb-4 text-center">
                <h2 id="desktopTitle" class="text-2xl font-bold mb-2 truncate">Select a song</h2>
                <p id="desktopArtist" class="text-gray-500 truncate">From library</p>
            </div>
            
            <!-- Progress -->
            <div class="px-8 py-4">
                <input type="range" id="desktopProgress" min="0" max="100" value="0" class="w-full mb-2" oninput="seek(this.value)">
                <div class="flex justify-between text-xs text-gray-600">
                    <span id="desktopCurrentTime">0:00</span>
                    <span id="desktopDuration">0:00</span>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center justify-center gap-6 pb-6">
                <button onclick="toggleShuffle()" id="desktopShuffle" class="p-2 text-gray-600 hover:text-white">
                    <i data-lucide="shuffle" class="w-5 h-5"></i>
                </button>
                <button onclick="prevTrack()" class="p-2 hover:text-gray-300">
                    <i data-lucide="skip-back" class="w-8 h-8 fill-white"></i>
                </button>
                <button onclick="togglePlay()" id="desktopPlayBtn" class="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition">
                    <i data-lucide="play" class="w-8 h-8 fill-black ml-1"></i>
                </button>
                <button onclick="nextTrack()" class="p-2 hover:text-gray-300">
                    <i data-lucide="skip-forward" class="w-8 h-8 fill-white"></i>
                </button>
                <button onclick="toggleRepeat()" id="desktopRepeat" class="p-2 text-gray-600 hover:text-white">
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Volume -->
            <div class="px-8 pb-8 flex items-center gap-3">
                <button onclick="toggleMute()" id="desktopMute">
                    <i data-lucide="volume-2" class="w-5 h-5 text-gray-500"></i>
                </button>
                <input type="range" id="desktopVolume" min="0" max="100" value="75" class="flex-1" oninput="setVolume(this.value)">
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="ml-96 flex-1 flex">
            <!-- Library -->
            <div class="flex-1 p-8 overflow-y-auto">
                <!-- Search -->
                <div class="mb-6">
                    <div class="relative max-w-md">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-600"></i>
                        <input type="text" id="desktopSearch" placeholder="Search songs, artists..." 
                               class="w-full bg-gray-900 rounded-full py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-gray-700"
                               oninput="search(this.value)">
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-2 mb-6 flex-wrap">
                    <button onclick="filter('all')" class="filter-btn px-4 py-2 bg-white text-black rounded-full text-sm font-medium">All</button>
                    <button onclick="filter('mandopop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">华语流行</button>
                    <button onclick="filter('kpop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">K-Pop</button>
                    <button onclick="filter('jpop')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">J-Pop</button>
                    <button onclick="filter('anime')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">Anime</button>
                    <button onclick="filter('electronic')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">Electronic</button>
                    <button onclick="filter('rock')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">Rock</button>
                    <button onclick="filter('classical')" class="filter-btn px-4 py-2 bg-gray-900 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-800">Classical</button>
                </div>
                
                <!-- Songs Grid -->
                <div id="desktopSongs" class="grid grid-cols-2 xl:grid-cols-3 gap-4">
                    <div class="col-span-full text-center py-12 text-gray-600">
                        <div class="animate-spin w-8 h-8 border-2 border-gray-700 border-t-white rounded-full mx-auto mb-4"></div>
                        Loading songs...
                    </div>
                </div>
            </div>
            
            <!-- Queue Sidebar -->
            <div class="w-80 border-l border-gray-900 p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold">Queue</h3>
                    <button onclick="clearQueue()" class="text-xs text-gray-500 hover:text-white">Clear</button>
                </div>
                <div id="desktopQueue" class="space-y-2">
                    <div class="text-gray-600 text-sm">Queue empty</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Element -->
    <audio id="audio" crossorigin="anonymous" preload="metadata"></audio>
    
    <script>
        // State
        let state = {
            isPlaying: false,
            currentTrack: null,
            queue: [],
            currentIndex: -1,
            isShuffle: false,
            isRepeat: false,
            volume: 75,
            isMuted: false,
            tracks: []
        };
        
        const audio = document.getElementById('audio');
        
        // Initialize
        window.onload = () => {
            lucide.createIcons();
            audio.volume = 0.75;
            setupAudioEvents();
            loadTracks();
        };
        
        // Audio Events
        function setupAudioEvents() {
            audio.addEventListener('timeupdate', () => {
                const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
                updateProgress(pct);
                updateTime();
            });
            
            audio.addEventListener('ended', () => {
                if (state.isRepeat) {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    nextTrack();
                }
            });
            
            audio.addEventListener('error', () => {
                console.error('Track error');
                nextTrack();
            });
        }
        
        // Load Tracks from APIs
        async function loadTracks() {
            try {
                const [audius, jamendo, archive] = await Promise.all([
                    fetchAudius(),
                    fetchJamendo(),
                    fetchArchive()
                ]);
                
                state.tracks = [...audius, ...jamendo, ...archive]
                    .filter(t => t.url && t.duration > 30)
                    .sort(() => Math.random() - 0.5);
                
                renderTracks();
            } catch (e) {
                console.error('Load error:', e);
                showError('Failed to load tracks');
            }
        }
        
        // Fetch Audius
        async function fetchAudius() {
            try {
                const res = await fetch('https://discoveryprovider.audius.co/v1/tracks/trending?app_name=Music&limit=50');
                const data = await res.json();
                return data.data.map(t => ({
                    id: 'a-' + t.id,
                    title: t.title,
                    artist: t.user?.name || 'Unknown',
                    cover: t.artwork?.['480x480'] || '',
                    url: `https://discoveryprovider.audius.co/v1/tracks/${t.id}/stream?app_name=Music`,
                    duration: t.duration || 0
                }));
            } catch (e) { return []; }
        }
        
        // Fetch Jamendo
        async function fetchJamendo() {
            try {
                const res = await fetch('https://api.jamendo.com/v3.0/tracks/?client_id=8b0e4b6f&format=json&order=popularity_total&limit=50&include=stats');
                const data = await res.json();
                return data.results.map(t => ({
                    id: 'j-' + t.id,
                    title: t.name,
                    artist: t.artist_name,
                    cover: t.album_image || t.image || '',
                    url: t.audio,
                    duration: t.duration || 0
                }));
            } catch (e) { return []; }
        }
        
        // Fetch Archive.org
        async function fetchArchive() {
            try {
                const res = await fetch('https://archive.org/advancedsearch.php?q=mediatype:audio+AND+format:mp3&fl=identifier,title,creator,downloads&sort=downloads+desc&rows=30&output=json');
                const data = await res.json();
                
                const tracks = await Promise.all(data.response.docs.map(async item => {
                    try {
                        const metaRes = await fetch(`https://archive.org/metadata/${item.identifier}`);
                        const meta = await metaRes.json();
                        const file = meta.files?.find(f => f.name.endsWith('.mp3') && f.size > 500000);
                        if (!file) return null;
                        return {
                            id: 'ar-' + item.identifier,
                            title: item.title?.substring(0, 60) || 'Unknown',
                            artist: item.creator || 'Archive',
                            cover: `https://archive.org/services/img/${item.identifier}`,
                            url: `https://archive.org/download/${item.identifier}/${file.name}`,
                            duration: Math.floor(file.length / 16000) || 180
                        };
                    } catch (e) { return null; }
                }));
                
                return tracks.filter(Boolean);
            } catch (e) { return []; }
        }
        
        // Render Tracks
        function renderTracks() {
            const query = (document.getElementById('mobileSearch')?.value || document.getElementById('desktopSearch')?.value || '').toLowerCase();
            const filtered = query 
                ? state.tracks.filter(t => t.title.toLowerCase().includes(query) || t.artist.toLowerCase().includes(query))
                : state.tracks;
            
            // Mobile
            const mobileContainer = document.getElementById('mobileSongs');
            if (mobileContainer) {
                mobileContainer.innerHTML = filtered.map((t, i) => `
                    <div onclick="playTrack(${state.tracks.indexOf(t)})" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-900 cursor-pointer ${state.currentTrack?.id === t.id ? 'bg-gray-900' : ''}">
                        <img src="${t.cover || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" class="w-12 h-12 rounded bg-gray-800 object-cover">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate ${state.currentTrack?.id === t.id ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                        </div>
                        ${state.currentTrack?.id === t.id && state.isPlaying ? 
                            '<div class="flex gap-0.5 items-end h-4"><div class="w-0.5 bg-white animate-pulse h-4"></div><div class="w-0.5 bg-white animate-pulse h-2"></div><div class="w-0.5 bg-white animate-pulse h-3"></div></div>' :
                            `<button onclick="event.stopPropagation(); addToQueue(${state.tracks.indexOf(t)})" class="p-2 text-gray-600"><i data-lucide="plus" class="w-4 h-4"></i></button>`
                        }
                    </div>
                `).join('');
                lucide.createIcons();
            }
            
            // Desktop
            const desktopContainer = document.getElementById('desktopSongs');
            if (desktopContainer) {
                desktopContainer.innerHTML = filtered.map((t, i) => `
                    <div onclick="playTrack(${state.tracks.indexOf(t)})" class="group bg-gray-900 rounded-lg p-4 hover:bg-gray-800 cursor-pointer transition ${state.currentTrack?.id === t.id ? 'ring-2 ring-white' : ''}">
                        <div class="relative mb-3">
                            <img src="${t.cover || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" class="w-full aspect-square rounded bg-black object-cover">
                            ${state.currentTrack?.id === t.id && state.isPlaying ? 
                                '<div class="absolute bottom-2 right-2 flex gap-0.5 items-end h-4 bg-black/50 px-2 py-1 rounded"><div class="w-0.5 bg-white h-4 animate-pulse"></div><div class="w-0.5 bg-white h-2 animate-pulse"></div><div class="w-0.5 bg-white h-3 animate-pulse"></div></div>' :
                                '<div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition"><i data-lucide="play" class="w-12 h-12 fill-white"></i></div>'
                            }
                        </div>
                        <div class="font-medium truncate">${escapeHtml(t.title)}</div>
                        <div class="text-sm text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
            
            updateCounts(filtered.length);
        }
        
        // Play Track
        async function playTrack(index) {
            const track = state.tracks[index];
            if (!track) return;
            
            // Add to queue if not exists
            const queueIndex = state.queue.findIndex(t => t.id === track.id);
            if (queueIndex === -1) {
                state.queue.push(track);
                state.currentIndex = state.queue.length - 1;
            } else {
                state.currentIndex = queueIndex;
            }
            
            state.currentTrack = track;
            audio.src = track.url;
            
            try {
                await audio.play();
                state.isPlaying = true;
                updateUI();
                renderQueue();
            } catch (e) {
                console.error('Play error:', e);
                nextTrack();
            }
        }
        
        // Controls
        function togglePlay() {
            if (!state.currentTrack) {
                if (state.tracks.length) playTrack(0);
                return;
            }
            
            if (state.isPlaying) {
                audio.pause();
                state.isPlaying = false;
            } else {
                audio.play();
                state.isPlaying = true;
            }
            updateUI();
        }
        
        function nextTrack() {
            if (!state.queue.length) return;
            
            if (state.isShuffle) {
                state.currentIndex = Math.floor(Math.random() * state.queue.length);
            } else {
                state.currentIndex = (state.currentIndex + 1) % state.queue.length;
            }
            
            const track = state.queue[state.currentIndex];
            state.currentTrack = track;
            audio.src = track.url;
            audio.play().then(() => {
                state.isPlaying = true;
                updateUI();
            }).catch(() => nextTrack());
        }
        
        function prevTrack() {
            if (!state.queue.length) return;
            state.currentIndex = (state.currentIndex - 1 + state.queue.length) % state.queue.length;
            const track = state.queue[state.currentIndex];
            state.currentTrack = track;
            audio.src = track.url;
            audio.play().then(() => {
                state.isPlaying = true;
                updateUI();
            });
        }
        
        function toggleShuffle() {
            state.isShuffle = !state.isShuffle;
            document.getElementById('mobileShuffle')?.classList.toggle('text-white', state.isShuffle);
            document.getElementById('desktopShuffle')?.classList.toggle('text-white', state.isShuffle);
        }
        
        function toggleRepeat() {
            state.isRepeat = !state.isRepeat;
            document.getElementById('mobileRepeat')?.classList.toggle('text-white', state.isRepeat);
            document.getElementById('desktopRepeat')?.classList.toggle('text-white', state.isRepeat);
        }
        
        // Volume
        function setVolume(val) {
            state.volume = parseInt(val);
            state.isMuted = state.volume === 0;
            audio.volume = state.volume / 100;
            updateVolumeIcon();
        }
        
        function toggleMute() {
            if (state.isMuted) {
                state.isMuted = false;
                state.volume = state.volume || 75;
                audio.volume = state.volume / 100;
                document.getElementById('mobileVolume').value = state.volume;
                document.getElementById('desktopVolume').value = state.volume;
            } else {
                state.isMuted = true;
                audio.volume = 0;
                document.getElementById('mobileVolume').value = 0;
                document.getElementById('desktopVolume').value = 0;
            }
            updateVolumeIcon();
        }
        
        function updateVolumeIcon() {
            const icon = state.isMuted || state.volume === 0 ? 'volume-x' : state.volume < 50 ? 'volume-1' : 'volume-2';
            const mobileBtn = document.getElementById('mobileMute');
            const desktopBtn = document.getElementById('desktopMute');
            if (mobileBtn) mobileBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${state.isMuted ? 'text-red-500' : 'text-gray-500'}"></i>`;
            if (desktopBtn) desktopBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${state.isMuted ? 'text-red-500' : 'text-gray-500'}"></i>`;
            lucide.createIcons();
        }
        
        // Progress
        function seek(val) {
            if (audio.duration) {
                audio.currentTime = (val / 100) * audio.duration;
            }
        }
        
        function updateProgress(pct) {
            document.getElementById('mobileProgress').value = pct;
            document.getElementById('desktopProgress').value = pct;
        }
        
        function updateTime() {
            const current = formatTime(audio.currentTime);
            const duration = formatTime(audio.duration || 0);
            document.getElementById('mobileCurrentTime').textContent = current;
            document.getElementById('mobileDuration').textContent = duration;
            document.getElementById('desktopCurrentTime').textContent = current;
            document.getElementById('desktopDuration').textContent = duration;
        }
        
        // Queue
        function addToQueue(index) {
            const track = state.tracks[index];
            if (state.queue.find(t => t.id === track.id)) {
                showToast('Already in queue');
                return;
            }
            state.queue.push(track);
            renderQueue();
            showToast('Added to queue');
        }
        
        function renderQueue() {
            // Mobile
            const mobileList = document.getElementById('mobileQueueList');
            if (mobileList) {
                mobileList.innerHTML = state.queue.map((t, i) => `
                    <div onclick="playFromQueue(${i})" class="flex items-center gap-3 p-3 rounded-lg ${i === state.currentIndex ? 'bg-gray-900' : 'hover:bg-gray-900'} cursor-pointer">
                        <div class="w-8 text-center text-sm text-gray-600">${i + 1}</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate ${i === state.currentIndex ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                        </div>
                        ${i === state.currentIndex && state.isPlaying ? '<div class="flex gap-0.5 items-end h-3"><div class="w-0.5 bg-white h-3 animate-pulse"></div><div class="w-0.5 bg-white h-1.5 animate-pulse"></div><div class="w-0.5 bg-white h-2 animate-pulse"></div></div>' : ''}
                    </div>
                `).join('');
            }
            
            // Desktop
            const desktopList = document.getElementById('desktopQueue');
            if (desktopList) {
                desktopList.innerHTML = state.queue.map((t, i) => `
                    <div onclick="playFromQueue(${i})" class="flex items-center gap-3 p-2 rounded hover:bg-gray-900 cursor-pointer ${i === state.currentIndex ? 'bg-gray-900' : ''}">
                        <div class="text-xs text-gray-600 w-4">${i + 1}</div>
                        <img src="${t.cover || ''}" class="w-10 h-10 rounded bg-gray-800 object-cover">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate ${i === state.currentIndex ? 'text-white' : ''}">${escapeHtml(t.title)}</div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(t.artist)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function playFromQueue(index) {
            state.currentIndex = index;
            state.currentTrack = state.queue[index];
            audio.src = state.currentTrack.url;
            audio.play().then(() => {
                state.isPlaying = true;
                updateUI();
                renderQueue();
            });
        }
        
        function clearQueue() {
            state.queue = [];
            state.currentIndex = -1;
            renderQueue();
        }
        
        // UI Updates
        function updateUI() {
            const track = state.currentTrack;
            if (!track) return;
            
            // Update text
            const elements = {
                'mobileTitle': track.title, 'mobileArtist': track.artist,
                'desktopTitle': track.title, 'desktopArtist': track.artist,
                'miniTitle': track.title, 'miniArtist': track.artist
            };
            
            for (const [id, text] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }
            
            // Update covers
            ['mobileCover', 'desktopCover', 'miniCover'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.src = track.cover || '';
            });
            
            // Update play buttons
            const playIcon = state.isPlaying ? 'pause' : 'play';
            const mobileBtn = document.getElementById('mobilePlayBtn');
            const desktopBtn = document.getElementById('desktopPlayBtn');
            const miniIcon = document.getElementById('miniPlayIcon');
            
            if (mobileBtn) mobileBtn.innerHTML = `<i data-lucide="${playIcon}" class="w-8 h-8 ${state.isPlaying ? '' : 'fill-black ml-1'}"></i>`;
            if (desktopBtn) desktopBtn.innerHTML = `<i data-lucide="${playIcon}" class="w-8 h-8 ${state.isPlaying ? '' : 'fill-black ml-1'}"></i>`;
            if (miniIcon) {
                miniIcon.setAttribute('data-lucide', playIcon);
                miniIcon.classList.toggle('fill-white', !state.isPlaying);
            }
            
            // CD animation
            const mobileCd = document.getElementById('mobileCd');
            const desktopCd = document.getElementById('desktopCd');
            if (mobileCd) mobileCd.classList.toggle('paused', !state.isPlaying);
            if (desktopCd) desktopCd.classList.toggle('paused', !state.isPlaying);
            
            // Mini player
            const mini = document.getElementById('mobileMini');
            if (mini && track) mini.classList.remove('hidden');
            
            lucide.createIcons();
            renderTracks();
        }
        
        // Navigation
        function showMobilePlayer() {
            document.getElementById('mobilePlayer').classList.remove('hidden');
            document.getElementById('mobileLibrary').classList.add('hidden');
        }
        
        function showMobileLibrary() {
            document.getElementById('mobilePlayer').classList.add('hidden');
            document.getElementById('mobileLibrary').classList.remove('hidden');
        }
        
        function toggleMobileQueue() {
            const modal = document.getElementById('mobileQueueModal');
            modal.classList.toggle('hidden');
        }
        
        // Search & Filter
        function search(query) {
            renderTracks();
        }
        
        function filter(type) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black');
                btn.classList.add('bg-gray-900', 'text-gray-400');
            });
            event.target.classList.remove('bg-gray-900', 'text-gray-400');
            event.target.classList.add('bg-white', 'text-black');
            
            // Search by filter
            const queries = {
                'all': '',
                'mandopop': '华语 中国 周杰伦 薛之谦',
                'kpop': 'K-Pop Korean BTS BLACKPINK',
                'jpop': 'J-Pop Japanese anime',
                'anime': 'anime opening ost soundtrack',
                'electronic': 'electronic edm house techno',
                'rock': 'rock alternative indie',
                'classical': 'classical piano orchestra'
            };
            
            const searchInput = document.getElementById('mobileSearch') || document.getElementById('desktopSearch');
            if (searchInput) {
                searchInput.value = queries[type] || '';
                renderTracks();
            }
        }
        
        // Helpers
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(msg) {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-white text-black px-4 py-2 rounded-full text-sm z-50';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        function showError(msg) {
            const error = document.createElement('div');
            error.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded text-sm z-50';
            error.textContent = msg;
            document.body.appendChild(error);
            setTimeout(() => error.remove(), 3000);
        }
        
        function updateCounts(count) {
            const el = document.getElementById('resultCount');
            if (el) el.textContent = count;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    if (e.shiftKey) nextTrack();
                    else seek(Math.min(100, parseInt(document.getElementById('mobileProgress')?.value || 0) + 5));
                    break;
                case 'ArrowLeft':
                    if (e.shiftKey) prevTrack();
                    else seek(Math.max(0, parseInt(document.getElementById('mobileProgress')?.value || 0) - 5));
                    break;
            }
        });
    </script>
</body>
</html>